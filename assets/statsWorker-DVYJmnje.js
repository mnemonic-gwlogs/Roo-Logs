(function(){"use strict";const cn=["selfBuffs","groupBuffs","squadBuffs"],un=c=>c!=null&&c.classification?c.classification==="Boon":!0,mn=c=>`b${c}`,Kn=(c,h)=>{const M=Array.isArray(c==null?void 0:c.activeTimes)?c.activeTimes:[],Y=typeof M[0]=="number"?M[0]:0;return Y>0?Y:h},ln=(c,h,M,Y,y,z,Ae)=>{const se=c==="selfBuffs"?1:Math.max(c==="groupBuffs"?z-1:Ae-1,0);return!se||!y?{generationMs:0,wastedMs:0}:h?{generationMs:M*y*se,wastedMs:Y*y*se}:{generationMs:M/100*y*se,wastedMs:Y/100*y*se}},Vn=c=>{const h=new Map,M=new Map;return c.forEach(z=>{const Ae=z.details;if(!Ae)return;const se=Ae.durationMS||0,ge=Ae.buffMap||{};Object.entries(ge).forEach(([ee,re])=>{if(!h.has(ee)){h.set(ee,re);return}const ke=h.get(ee)||{},me={name:ke.name||re.name,stacking:ke.stacking??re.stacking,icon:ke.icon||re.icon,classification:ke.classification||re.classification};h.set(ee,me)});const ye=(Ae.players||[]).filter(ee=>!ee.notInSquad),Xe=ye.length,Ke=new Map;ye.forEach(ee=>{const re=ee.group??0;Ke.set(re,(Ke.get(re)||0)+1)}),ye.forEach(ee=>{const re=ee.account||ee.name||ee.character_name||"Unknown",ke=ee.profession||"Unknown",me=ee.group??0,Be=Ke.get(me)||1,_e=Kn(ee,se);M.has(re)||M.set(re,{account:re,profession:ke,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const ce=M.get(re);ce.profession=ke,ke!=="Unknown"&&(ce.professions.add(ke),ce.professionTimeMs[ke]=(ce.professionTimeMs[ke]||0)+_e),ce.activeTimeMs+=_e,ce.numFights+=1,ce.groupSupported+=Be,ce.squadSupported+=Xe,cn.forEach(ve=>{(ee[ve]||[]).forEach(v=>{var Fe,Ye,Qe,tt;if(typeof(v==null?void 0:v.id)!="number")return;const de=mn(v.id),De=ge[de];if(!un(De))return;const we=(De==null?void 0:De.stacking)??!1,Te=((Ye=(Fe=v.buffData)==null?void 0:Fe[0])==null?void 0:Ye.generation)??0,pe=((tt=(Qe=v.buffData)==null?void 0:Qe[0])==null?void 0:tt.wasted)??0,{generationMs:je,wastedMs:Ne}=ln(ve,we,Te,pe,se,Be,Xe);!je&&!Ne||(h.has(de)||h.set(de,De||{}),ce.boons[de]||(ce.boons[de]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),ce.boons[de][ve].generationMs+=je,ce.boons[de][ve].wastedMs+=Ne)})})})}),{boonTables:Array.from(h.keys()).filter(z=>un(h.get(z))).map(z=>{const Ae=h.get(z)||{},se=[];return M.forEach(ge=>{var ee;const Me=ge.boons[z];if(!Me||!cn.some(re=>Me[re].generationMs>0||Me[re].wastedMs>0))return;const Xe=Array.from(ge.professions||[]).filter(re=>re&&re!=="Unknown");let Ke=ge.profession;if(Xe.length>0){Ke=Xe[0];let re=((ee=ge.professionTimeMs)==null?void 0:ee[Ke])||0;Xe.forEach(ke=>{var Be;const me=((Be=ge.professionTimeMs)==null?void 0:Be[ke])||0;me>re&&(re=me,Ke=ke)})}se.push({account:ge.account,profession:Ke||"Unknown",professionList:Xe,activeTimeMs:ge.activeTimeMs||1,numFights:ge.numFights||1,groupSupported:ge.groupSupported||1,squadSupported:ge.squadSupported||1,categories:{selfBuffs:{...Me.selfBuffs},groupBuffs:{...Me.groupBuffs},squadBuffs:{...Me.squadBuffs}}})}),{id:z,name:Ae.name||z,icon:Ae.icon,stacking:Ae.stacking??!1,rows:se}}).filter(z=>z.rows.length>0)}},Jt=(c,h,M,Y,y,z,Ae={})=>{var ee,re,ke,me;const ge=((c==null?void 0:c[h])||[]).find(Be=>Be.id===M);if(!ge)return{generationMs:0,wastedMs:0};const Me=Ae[mn(M)],ye=(Me==null?void 0:Me.stacking)??!1,Xe=((re=(ee=ge.buffData)==null?void 0:ee[0])==null?void 0:re.generation)??0,Ke=((me=(ke=ge.buffData)==null?void 0:ke[0])==null?void 0:me.wasted)??0;return ln(h,ye,Xe,Ke,Y,y,z)};var Gn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Yn=Gn,Xt="count",Jn=c=>(c||0)/1e3,Xn=(c,h)=>{var y;if(!c)return 0;const M=(y=Yn.methods.tiered)==null?void 0:y.tiers;if(!M)return c;const Y=h/Math.max(c,1);return Y<=M.shortMs?c*M.weights.short:Y<=M.mediumMs?c*M.weights.medium:c*M.weights.long},dn=(c,h,M)=>M==="duration"?Jn(h):M==="tiered"?Xn(c,h):c;function Qn(c,h=Xt){var z;const M=(z=c.statsAll)==null?void 0:z[0],Y=Number((M==null?void 0:M.appliedCrowdControl)??0),y=Number((M==null?void 0:M.appliedCrowdControlDuration)??0);return dn(Y,y,h)}function Zn(c,h){const M=(h==null?void 0:h.durationMS)||0,Y=(h==null?void 0:h.buffMap)||{},y=c.filter(se=>!se.notInSquad),z=y.length,Ae=new Map;y.forEach(se=>{const ge=se.group??0;Ae.set(ge,(Ae.get(ge)||0)+1)}),y.forEach(se=>{const ge=Ae.get(se.group??0)||1,Me=Jt(se,"selfBuffs",1122,M,ge,z,Y),ye=Jt(se,"squadBuffs",1122,M,ge,z,Y);se.stabGeneration=(Me.generationMs+ye.generationMs)/1e3})}function yn(c){if(!c.statsTargets)return 0;let h=0;for(const M of c.statsTargets)M&&M.length>0&&(h+=M[0].downContribution||0);return h}function es(c){if(!c.extBarrierStats||!c.extBarrierStats.outgoingBarrierAllies)return 0;let h=0;for(const M of c.extBarrierStats.outgoingBarrierAllies)if(M)for(const Y of M)Y&&(h+=Y.barrier||0);return h}function ts(c){if(!c.extHealingStats||!c.extHealingStats.outgoingHealingAllies)return 0;let h=0;for(const M of c.extHealingStats.outgoingHealingAllies)if(M)for(const Y of M)Y&&(h+=Y.healing||0);return h}const fn=c=>{var h,M,Y,y;return(((M=(h=c.support)==null?void 0:h[0])==null?void 0:M.condiCleanse)||0)+(((y=(Y=c.support)==null?void 0:Y[0])==null?void 0:y.condiCleanseSelf)||0)},gn=(c,h=Xt)=>{var z;const M=(z=c.support)==null?void 0:z[0],Y=Number((M==null?void 0:M.boonStrips)??0),y=Number((M==null?void 0:M.boonStripsTime)??0);return dn(Y,y,h)},hn=c=>yn(c),pn=c=>ts(c),bn=c=>es(c),Dn=(c,h=Xt)=>Qn(c,h),ns=(c,h)=>Zn(c,h),ss="count",is={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},os={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},kn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),as={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},wt=(c,h)=>{if(!c||h===void 0||h===null)return;const M=Number(h);return Number.isFinite(M)?c[`b${M}`]||c[String(M)]:c[String(h)]},Bt=c=>{if(!c)return null;const h=c.trim().toLowerCase(),M=kn.get(h);if(M)return M;const Y=h.split(/[^a-z]+/).filter(Boolean);for(const y of Y){const z=kn.get(y);if(z)return z}return null},rs=c=>Bt(c),Nn=c=>{const h=new Map;return c&&(Object.values(c).forEach(M=>{if(!(M!=null&&M.icon)||!(M!=null&&M.name))return;const Y=Bt(M.name);Y&&(h.has(Y)||h.set(Y,M.icon))}),Object.entries(as).forEach(([M,Y])=>{h.has(M)||h.set(M,Y)})),h},Et=(c,h,M)=>{var Y;if(h&&M){const y=(Y=wt(M,h))==null?void 0:Y.name,z=Bt(y);if(z)return z}return c?Bt(c):null},cs=c=>{const h=(c==null?void 0:c.account)||"Unknown";return h&&h!=="Unknown"?h:(c==null?void 0:c.name)||"Unknown"||null},us=c=>{if(!c||c.length===0)return 0;let h=0,M=null;return c.forEach(Y=>{const y=Number(Y[1]??0);if(Number.isFinite(y)){if(M===null){M=y;return}y>M&&(h+=y-M),M=y}}),h},ms=c=>{if(!c||c.length===0)return 0;let h=0;return c.forEach(M=>{const Y=Number(M[0]??0),y=Number(M[1]??0);Number.isFinite(y)&&Y!==0&&y>0&&(h+=1)}),h},ls=c=>{const{players:h,targets:M,skillMap:Y,buffMap:y}=c,z=c.getPlayerKey||cs,Ae=Nn(y),se={},ge={};h.forEach(ee=>{if(ee!=null&&ee.notInSquad)return;const re=z(ee);re&&(se[re]||(se[re]={}),ee!=null&&ee.totalDamageDist&&ee.totalDamageDist.forEach(ke=>{ke&&ke.forEach(me=>{if(!me.id)return;let Be=`Skill ${me.id}`,_e;Y&&(Y[`s${me.id}`]?(Be=Y[`s${me.id}`].name||Be,_e=Y[`s${me.id}`].icon||_e):Y[`${me.id}`]&&(Be=Y[`${me.id}`].name||Be,_e=Y[`${me.id}`].icon||_e));const ce=wt(y,me.id);Be.startsWith("Skill ")&&(ce!=null&&ce.name)&&(Be=ce.name,_e=ce.icon||_e);const ve=Et(Be,me.id,y);if(!ve)return;const nt=ce==null?void 0:ce.name,v=Ae.get(ve)||(ce==null?void 0:ce.icon),de=Be.startsWith("Skill ")?nt||ve:Be,De=_e||(ce==null?void 0:ce.icon),we=Number(me.connectedHits??0),Te=Number(me.hits??0),pe=we>0?we:Te,je=Number(me.totalDamage??0);if(!Number.isFinite(pe)&&!Number.isFinite(je))return;const Ne=ge[ve]||{name:ve,icon:v,applications:0,damage:0};Ne.applications+=Number.isFinite(pe)?pe:0,Ne.damage+=Number.isFinite(je)?je:0,!Ne.icon&&v&&(Ne.icon=v),ge[ve]=Ne;const Fe=se[re][ve]||{icon:v,applications:0,damage:0,skills:{}};Fe.applications+=Number.isFinite(pe)?pe:0,Fe.damage+=Number.isFinite(je)?je:0;const Ye=Fe.skills[de]||{name:de,hits:0,damage:0,icon:De};Ye.hits+=Number.isFinite(pe)?pe:0,Ye.damage+=Number.isFinite(je)?je:0,!Ye.icon&&De&&(Ye.icon=De),Fe.skills[de]=Ye,!Fe.icon&&v&&(Fe.icon=v),se[re][ve]=Fe})}))});const Me=new Map;h.forEach(ee=>{if(ee!=null&&ee.notInSquad)return;const re=z(ee);re&&ee!=null&&ee.name&&Me.set(ee.name,re)});let ye=0,Xe=0,Ke=0;return M.forEach(ee=>{ee!=null&&ee.buffs&&ee.buffs.forEach(re=>{const ke=Number(re==null?void 0:re.id);if(!Number.isFinite(ke))return;const me=wt(y,ke),Be=Bt(me==null?void 0:me.name);if(!Be||me!=null&&me.classification&&me.classification!=="Condition")return;const _e=Be;if(!_e)return;const ce=re.statesPerSource||{};Ke+=1,Object.entries(ce).forEach(([ve,nt])=>{var pe;const v=Me.get(ve);if(!v)return;Xe+=1;const de=us(nt),De=ms(nt);ye+=de;const we=((pe=se[v])==null?void 0:pe[_e])||{applications:0,damage:0,skills:{}};we.applicationsFromBuffs=(we.applicationsFromBuffs||0)+de,we.applicationsFromBuffsActive=(we.applicationsFromBuffsActive||0)+De,se[v]=se[v]||{},se[v][_e]=we;const Te=ge[_e]||{name:_e,applications:0,damage:0};Te.applicationsFromBuffs=(Te.applicationsFromBuffs||0)+de,Te.applicationsFromBuffsActive=(Te.applicationsFromBuffsActive||0)+De,ge[_e]=Te})})}),{playerConditions:se,summary:ge,meta:{buffStateApplicationsTotal:ye,targetBuffEntriesSeen:Ke,buffStateSourcesSeen:Xe}}},ds=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),fs=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],gs=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"minionDamageTaken",label:"Minion Damage Taken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],hs=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],ps=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],bs=new Set([10244]),Ds=(c,h)=>{var y;if(bs.has(c))return!0;const M=(h==null?void 0:h[`s${c}`])||(h==null?void 0:h[`${c}`]),Y=((y=M==null?void 0:M.name)==null?void 0:y.toLowerCase())||"";return ps.some(z=>Y.includes(z))},Tt=c=>{if(!c||!Number.isFinite(c))return"--:--";const h=Math.max(0,Math.round(c/1e3)),M=Math.floor(h/3600),Y=Math.floor(h%3600/60),y=h%60;return M>0?`${M}:${String(Y).padStart(2,"0")}:${String(y).padStart(2,"0")}`:`${Y}:${String(y).padStart(2,"0")}`},$t={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function Sn(c){return $t[c]||$t.Unknown}const ks=c=>{if(c==null||c==="")return 0;if(typeof c=="number")return!Number.isFinite(c)||c<=0?0:c>1e12?c:c*1e3;if(c instanceof Date){const Ae=c.getTime();return Number.isFinite(Ae)&&Ae>0?Ae:0}const h=String(c).trim();if(!h)return 0;const M=Number(h);if(Number.isFinite(M)&&M>0)return M>1e12?M:M*1e3;const Y=Date.parse(h);if(Number.isFinite(Y)&&Y>0)return Y;const y=h.replace(/([+-]\d{2})$/,"$1:00"),z=Date.parse(y);return Number.isFinite(z)&&z>0?z:0},ze=(c,h)=>ks((c==null?void 0:c.timeStartStd)??(c==null?void 0:c.timeStart)??(c==null?void 0:c.timeEndStd)??(c==null?void 0:c.timeEnd)??(c==null?void 0:c.timeStartText)??(c==null?void 0:c.timeEndText)??(c==null?void 0:c.uploadTime)??(h==null?void 0:h.uploadTime)),Ns=({logs:c,precomputedStats:h,mvpWeights:M,statsViewSettings:Y,disruptionMethod:y,includePlayerSkillMap:z})=>{const Ae=ee=>{var ke;return(Array.isArray((ke=ee==null?void 0:ee.details)==null?void 0:ke.players)?ee.details.players:[]).length>0},se=c.filter(ee=>Ae(ee)),ge=Y||os,Me=M||is,ye=ee=>{if(!ee||typeof ee!="object")return ee;const re=Array.isArray(ee.fightBreakdown)?ee.fightBreakdown:null;if(!re||re.length===0)return ee;const ke=v=>Array.isArray(v)&&v.some(de=>de&&Number(de.count)>0),me=new Map,Be=new Map;c.forEach(v=>{var we;const de=(v==null?void 0:v.filePath)||(v==null?void 0:v.id);de&&me.set(String(de),v);const De=(v==null?void 0:v.permalink)||((we=v==null?void 0:v.details)==null?void 0:we.permalink);typeof De=="string"&&De.trim()&&Be.set(De.trim(),v)});const _e=re.map(v=>{var je;if(!v||typeof v!="object")return v;const de=v.id?String(v.id):"",De=typeof v.permalink=="string"?v.permalink.trim():"",we=(de?me.get(de):void 0)||(De?Be.get(De):void 0);if(!we)return v;let Te=v;if(Number(v.timestamp)<=0){const Ne=ze(we==null?void 0:we.details,we);Ne&&(Te={...Te,timestamp:Ne})}const pe=(je=we==null?void 0:we.details)==null?void 0:je.teamBreakdown;return ke(pe)&&(Te={...Te,teamBreakdown:pe}),Te}),ce=Array.isArray(ee.fightDiffMode)?ee.fightDiffMode:[],nt=ce.some(v=>Array.isArray(v==null?void 0:v.targetFocus)&&v.targetFocus.some(de=>Number((de==null?void 0:de.damage)||0)>0||Number((de==null?void 0:de.hits)||0)>0))?ce:_e.map((v,de)=>{const De=v&&typeof v.enemyClassCounts=="object"&&v.enemyClassCounts?v.enemyClassCounts:{},we=Object.entries(De).map(([Je,et])=>({label:String(Je||"Unknown"),count:Number(et||0)})).filter(Je=>Je.count>0).sort((Je,et)=>et.count-Je.count||Je.label.localeCompare(et.label)),Te=we.reduce((Je,et)=>Je+et.count,0),pe=we.map(Je=>({label:Je.label,damage:Je.count,hits:0,share:Te>0?Je.count/Te:0})),je=Number((v==null?void 0:v.enemyDowns)||0),Ne=Number((v==null?void 0:v.enemyDeaths)||0),Fe=Number((v==null?void 0:v.alliesDown)||0),Ye=Number((v==null?void 0:v.alliesDead)||0),Qe=Number((v==null?void 0:v.totalOutgoingDamage)||0),tt=Number((v==null?void 0:v.totalIncomingDamage)||0),We=[{metricId:"winFlag",metricLabel:"Win (1) / Loss (0)",higherIsBetter:!0,value:v!=null&&v.isWin?1:0},{metricId:"squadCount",metricLabel:"Squad Size",higherIsBetter:!0,value:Number((v==null?void 0:v.squadCount)||0)},{metricId:"enemyCount",metricLabel:"Enemy Count",higherIsBetter:!1,value:Number((v==null?void 0:v.enemyCount)||0)},{metricId:"squadKdr",metricLabel:"Squad KDR",higherIsBetter:!0,value:Ye>0?Ne/Ye:Ne},{metricId:"enemyDeaths",metricLabel:"Enemy Deaths",higherIsBetter:!0,value:Ne},{metricId:"enemyDowns",metricLabel:"Enemy Downs",higherIsBetter:!0,value:je},{metricId:"squadDeaths",metricLabel:"Squad Deaths",higherIsBetter:!1,value:Ye},{metricId:"squadDowns",metricLabel:"Squad Downs",higherIsBetter:!1,value:Fe},{metricId:"damageDelta",metricLabel:"Damage Delta",higherIsBetter:!0,value:Qe-tt},{metricId:"outgoingDamage",metricLabel:"Outgoing Damage",higherIsBetter:!0,value:Qe},{metricId:"incomingDamage",metricLabel:"Incoming Damage",higherIsBetter:!1,value:tt},{metricId:"barrierIncomingAbsorb",metricLabel:"Barrier Absorption (Incoming)",higherIsBetter:!0,value:Number((v==null?void 0:v.incomingBarrierAbsorbed)||0)},{metricId:"enemyBarrierAbsorb",metricLabel:"Enemy Barrier Absorption",higherIsBetter:!1,value:Number((v==null?void 0:v.outgoingBarrierAbsorbed)||0)},{metricId:"alliesRevived",metricLabel:"Allies Revived (Players)",higherIsBetter:!0,value:Number((v==null?void 0:v.alliesRevived)||0)}];return{id:String((v==null?void 0:v.id)||`fight-${de+1}`),shortLabel:`F${de+1}`,fullLabel:`${String((v==null?void 0:v.mapName)||(v==null?void 0:v.label)||"Unknown Map")} • ${String((v==null?void 0:v.duration)||"--:--")}`,mapName:String((v==null?void 0:v.mapName)||""),timestamp:Number((v==null?void 0:v.timestamp)||0),duration:String((v==null?void 0:v.duration)||"--:--"),isWin:!!(v!=null&&v.isWin),targetFocus:pe,squadMetrics:We}});return{...ee,fightBreakdown:_e,fightDiffMode:nt}},Xe=(()=>{if(h)return ye(h);const ee=y||ss,re=ge.topSkillDamageSource||"target",ke=ge.topSkillsMetric||"damage",me=se.length;let Be=0,_e=0,ce=0,ve=0,nt=0,v=0,de=0,De=0;const we=e=>{const m=((e==null?void 0:e.players)||[]).filter(Z=>!Z.notInSquad);let F=0,f=0,j=0,T=0;return m.forEach(Z=>{var l;const J=(l=Z.defenses)==null?void 0:l[0];if(!J)return;const ie=Number(J.downCount||0),E=Number(J.deadCount||0);F+=ie+E,j+=E}),m.forEach(Z=>{!Z.statsTargets||Z.statsTargets.length===0||Z.statsTargets.forEach(J=>{Array.isArray(J)&&J.forEach(ie=>{if(!ie)return;const E=Number(ie.downed||0),l=Number(ie.killed||0);f+=E+l,T+=l})})}),{squadDownsDeaths:F,enemyDownsDeaths:f,squadDeaths:j,enemyDeaths:T}},Te=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:m}=we(e);return t>0||m>0?m>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},pe=new Map,je=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),Ne={},Fe={},Ye=new Map,Qe={},tt={},We={},Je=new Map,et=new Map,Ot=new Set(Object.keys($t)),Ht=Object.keys($t).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),jt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],rt=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Ot.has(t))return t;const m=t.toLowerCase();for(const f of Ht)if(m.includes(f.toLowerCase()))return f;return jt.find(f=>m.includes(f.toLowerCase()))||t||"Unknown"},yt=e=>e!=null&&e.classification?e.classification==="Boon":!0,zt=new Map,Kt=new Map,Pt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),Re=e=>{const t=Number(e);return Number.isFinite(t)?t:0},Fn=e=>{const t=String(e).split("|"),m=t[0]||"Unknown",F=rt(t[1]||"Unknown"),f=t[2]||m||"Unknown";return{name:m,profession:F,account:f}},Bn=(e,t,m)=>{let F=e.get(t);return F?m.profession&&!F.professionList.includes(m.profession)&&F.professionList.push(m.profession):(F={account:m.account,name:m.name,profession:m.profession,professionList:m.profession?[m.profession]:[],activeMs:0,mitigationTotals:Pt()},e.set(t,F)),F},En=(e,t,m)=>{let F=e.get(t);return F?m.profession&&!F.professionList.includes(m.profession)&&F.professionList.push(m.profession):(F={account:m.account,name:m.name,profession:m.profession,professionList:m.profession?[m.profession]:[],activeMs:0,mitigationTotals:Pt(),minion:m.minion},e.set(t,F)),F},In=(e,t)=>{e.totalHits+=Re((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=Re(t==null?void 0:t.blocked),e.evaded+=Re(t==null?void 0:t.evaded),e.glanced+=Re(t==null?void 0:t.glanced),e.missed+=Re(t==null?void 0:t.missed),e.invulned+=Re(t==null?void 0:t.invulned),e.interrupted+=Re(t==null?void 0:t.interrupted),e.totalMitigation+=Re((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=Re((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},ws=e=>Object.values(e).some(t=>t>0),en=new Map,Ts=e=>{const t=en.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const m=t.connectedHits||0,F=m>0?t.totalDamage/m:0,f=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:F,min:f,hits:m}},Pn=new Map,xn=new Map,Ln=(e,t,m)=>{const F=e.get(t)||Pt();return F.totalHits+=m.totalHits,F.blocked+=m.blocked,F.evaded+=m.evaded,F.glanced+=m.glanced,F.missed+=m.missed,F.invulned+=m.invulned,F.interrupted+=m.interrupted,e.set(t,F),F};se.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(F=>{const f=(F==null?void 0:F.totalDamageDist)||[],j=Array.isArray(f)?f[0]:null;j==null||j.forEach(T=>{if(!(T!=null&&T.id))return;const Z=Number(T.id),J=en.get(Z)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};J.totalDamage+=Number(T.totalDamage||0),J.connectedHits+=Number(T.connectedHits||0);const ie=Number.isFinite(Number(T.min))?Number(T.min):0;J.minTotal+=ie,J.minCount+=1,en.set(Z,J)})})}),se.forEach(e=>{var r,N;const t=e.details;if(!t)return;const m=t.players,F=t.targets||[],f=t.combatReplayMetaData||{},j=(f==null?void 0:f.inchToPixel)>0?f.inchToPixel:1,T=(f==null?void 0:f.pollingRate)>0?f.pollingRate:1,Z=5e3,J=s=>Array.isArray(s)?s.map(o=>Array.isArray(o)?[Number(o[0]),Number(o[1])]:null).filter(o=>!!o&&Number.isFinite(o[0])):[];let ie=[],E=t.durationMS||0,l=!1;const d=m.find(s=>(s==null?void 0:s.hasCommanderTag)&&!(s!=null&&s.notInSquad));(r=d==null?void 0:d.combatReplayData)!=null&&r.positions&&(ie=d.combatReplayData.positions,J(d.combatReplayData.dead).forEach(([o])=>{o>0&&(l=!0,E=Math.min(E,o))}));const $=s=>{var D;const o=(D=s.statsAll)==null?void 0:D[0];if((o==null?void 0:o.distToCom)!==void 0&&(o==null?void 0:o.distToCom)!=="Infinity")return Math.round(Number(o.distToCom));if((o==null?void 0:o.stackDist)!==void 0)return Math.round(Number(o.stackDist))||0;if(s.hasCommanderTag)return 0;const g=s.combatReplayData;if(!(g!=null&&g.positions)||!ie.length)return 0;const _=g.positions,u=J(g.dead),a=J(g.down),V=Math.floor((g.start||0)/T);let p=0;if(u.length&&a.length)for(const[q]of u){if(q<0)continue;const W=Math.max(0,Math.floor(q/T))-V;for(const[O,w]of a){if(q!==w)continue;const x=l&&O>E?Math.max(1,Math.floor(E/T)):W,K=Math.max(0,Math.min(x,_.length,ie.length));if(K<=0)continue;let ne=0;for(let oe=0;oe<K;oe++){const[ue,he]=_[oe],[Se,Ie]=ie[oe];ne+=Math.hypot(ue-Se,he-Ie)}p=Math.round(ne/K/j)}}return p},k=m.filter(s=>!s.notInSquad);ce+=k.length,ve+=F.filter(s=>!s.isFake).length,ns(m,{durationMS:t.durationMS,buffMap:t.buffMap});const{squadDeaths:R,enemyDeaths:H}=we(t);nt+=R,v+=H,De+=R,de+=H,Te(t)?Be++:_e++;const b=t.skillMap?Number((N=Object.keys(t.skillMap).find(s=>{var o,g;return((g=(o=t.skillMap)==null?void 0:o[s])==null?void 0:g.name)==="Battle Standard"}))==null?void 0:N.replace(/^s/,"")):null;m.forEach((s,o)=>{var Ve,Ue,$e,ut,st,vt,Dt,mt,lt,xt,Nt,St,Ft;if(s.notInSquad)return;const g=s.account||"Unknown",_=g!=="Unknown"?g:s.name||"Unknown",u=s.name||"Unknown";pe.has(_)||pe.set(_,{name:u,account:_,characterNames:new Set,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},defenseMinionDamageTaken:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:s.profession||"Unknown",professions:new Set,professionTimeMs:{},squadActiveMs:0,firstSeenFightTs:0,lastSeenFightTs:0,lastSeenFightDurationMs:0,isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const a=pe.get(_);if(s.hasCommanderTag&&(a.isCommander=!0),u!=="Unknown"&&a.characterNames.add(String(u)),s.profession&&s.profession!=="Unknown"){a.profession=s.profession,a.professions.add(s.profession);const U=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:t.durationMS||0;a.professionTimeMs[s.profession]=(a.professionTimeMs[s.profession]||0)+U}a.logsJoined++,a.downContrib+=hn(s),a.cleanses+=fn(s),a.strips+=gn(s,ee),a.healing+=pn(s),a.barrier+=bn(s),a.cc+=Dn(s,ee),a.stab+=s.stabGeneration||0;const V=$(s);V<=Z&&(a.totalDist+=V,a.distCount++),(Ve=s.defenses)!=null&&Ve[0]&&(a.dodges+=s.defenses[0].dodgeCount||0,a.downs+=s.defenses[0].downCount||0,a.deaths+=s.defenses[0].deadCount||0),t.durationMS&&(a.totalFightMs+=t.durationMS);const p=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:t.durationMS||0;a.squadActiveMs+=p;const D=ze(t,e),q=Number((t==null?void 0:t.durationMS)||0);if(D>0&&((a.firstSeenFightTs<=0||D<a.firstSeenFightTs)&&(a.firstSeenFightTs=D),a.lastSeenFightTs<=0||D>a.lastSeenFightTs?(a.lastSeenFightTs=D,a.lastSeenFightDurationMs=q):D===a.lastSeenFightTs&&q>a.lastSeenFightDurationMs&&(a.lastSeenFightDurationMs=q)),a.defenseActiveMs+=p,a.supportActiveMs+=p,a.healingActiveMs+=p,Array.isArray(s.buffUptimes)&&s.buffUptimes.length>0&&s.buffUptimes.forEach(U=>{var At,Ee,Yt,Ut,te,le;if(typeof(U==null?void 0:U.id)!="number")return;const L=`b${U.id}`,A=((At=t.buffMap)==null?void 0:At[L])||((Ee=t.buffMap)==null?void 0:Ee[String(U.id)]);if(!A||yt(A))return;const B=Number(((Ut=(Yt=U.buffData)==null?void 0:Yt[0])==null?void 0:Ut.uptime)??0),G=Number(((le=(te=U.buffData)==null?void 0:te[0])==null?void 0:le.presence)??0);if((!Number.isFinite(B)||B<=0)&&(!Number.isFinite(G)||G<=0))return;const ae=(A==null?void 0:A.stacking)??!1,Pe=(ae?Number.isFinite(B)?B:0:Number.isFinite(B)?B/100:0)*p,qe=ae?G:B,Ge=Math.min(Math.max(Number.isFinite(qe)?qe:0,0),100)/100*p,Ze=Number.isFinite(Pe)&&Pe>0,kt=Number.isFinite(Ge)&&Ge>0;if(!Ze&&!kt)return;const ot=rs(A==null?void 0:A.name);if(ot&&ds.has(ot)&&(!(A!=null&&A.classification)||A.classification==="Condition")){const it=Pe/1e3,He=A==null?void 0:A.icon,Mt=Qe[ot]||{name:ot,icon:He,applications:0,damage:0};Mt.applicationsFromUptime=(Mt.applicationsFromUptime||0)+it,!Mt.icon&&He&&(Mt.icon=He),Qe[ot]=Mt;const Ct=a.outgoingConditions[ot]||{applications:0,damage:0,skills:{},icon:He};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+it,!Ct.icon&&He&&(Ct.icon=He),a.outgoingConditions[ot]=Ct;const qt=tt[ot]||{name:ot,icon:He,applications:0,damage:0};qt.applicationsFromUptime=(qt.applicationsFromUptime||0)+it,!qt.icon&&He&&(qt.icon=He),tt[ot]=qt;const _t=a.incomingConditions[ot]||{applications:0,damage:0,skills:{},icon:He};_t.applicationsFromUptime=(_t.applicationsFromUptime||0)+it,!_t.icon&&He&&(_t.icon=He),a.incomingConditions[ot]=_t}Je.has(L)||Je.set(L,{name:A==null?void 0:A.name,stacking:ae,icon:A==null?void 0:A.icon}),et.has(L)||et.set(L,new Map);const Gt=et.get(L),Lt=a.account||s.account||s.name||"Unknown";let ft=Gt.get(Lt);ft||(ft={account:Lt,profession:a.profession||s.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,uptimeMs:0,durationMs:0},Gt.set(Lt,ft));const pt=s.profession||a.profession;pt&&pt!=="Unknown"&&(ft.professions.add(pt),ft.professionTimeMs[pt]=(ft.professionTimeMs[pt]||0)+p,ft.profession=pt),ft.totalMs+=Ze?Pe:0,ft.uptimeMs+=kt?Ge:0,ft.durationMs+=p}),(Ue=s.defenses)!=null&&Ue[0]){const U=B=>{let G=String(B||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";return G.toUpperCase().includes("UNKNOWN")&&(G="Unknown"),G},A=(()=>{const B=Array.isArray(s==null?void 0:s.minions)?s.minions:[];if(B.length===0)return{total:0,byMinion:{}};let G=0;const ae={};return B.forEach(be=>{const Pe=Array.isArray(be==null?void 0:be.totalDamageTakenDist)?be.totalDamageTakenDist:[],qe=Array.isArray(Pe[0])?Pe[0]:[],dt=U(be==null?void 0:be.name);qe.forEach(Ge=>{const Ze=Number((Ge==null?void 0:Ge.totalDamage)??(Ge==null?void 0:Ge.damageTaken)??0);Number.isFinite(Ze)&&(G+=Ze,ae[dt]=(ae[dt]||0)+Ze)})}),{total:G,byMinion:ae}})();A.byMinion&&typeof A.byMinion=="object"&&Object.entries(A.byMinion).forEach(([B,G])=>{const ae=Number(G||0);!Number.isFinite(ae)||ae<=0||(a.defenseMinionDamageTaken[B]=(a.defenseMinionDamageTaken[B]||0)+ae)}),gs.forEach(B=>{const G=B.id==="minionDamageTaken"?A.total:Number(s.defenses[0][B.field]??0);Number.isFinite(G)&&(a.defenseTotals[B.id]=(a.defenseTotals[B.id]||0)+G)})}($e=s.support)!=null&&$e[0]&&hs.forEach(U=>{let L=Number(s.support[0][U.field]??0);Number.isFinite(L)&&(je.has(U.field)&&L>999999&&(L=0),a.supportTotals[U.id]=(a.supportTotals[U.id]||0)+L)});const W=(U,L)=>{Number.isFinite(L)&&(a.healingTotals[U]=(a.healingTotals[U]||0)+L)},O=(U,L)=>Array.isArray(U)?U.reduce((A,B)=>A+Number((B==null?void 0:B[L])??0),0):0,w=(U,L,A)=>{if(!Number.isFinite(A)||A<=0)return;const B=m[L],G=L===o,ae=B==null?void 0:B.notInSquad,be=!ae,Pe=be&&(B==null?void 0:B.group)!=null&&B.group===s.group;W(U,A),be&&W(`squad${U[0].toUpperCase()}${U.slice(1)}`,A),Pe&&W(`group${U[0].toUpperCase()}${U.slice(1)}`,A),G&&W(`self${U[0].toUpperCase()}${U.slice(1)}`,A),ae&&W(`offSquad${U[0].toUpperCase()}${U.slice(1)}`,A)};if(Array.isArray(s.rotation)){let U=0;s.rotation.forEach(L=>{var B;if(!(L!=null&&L.id)||!Ds(L.id,t.skillMap))return;const A=((B=L.skills)==null?void 0:B.length)||0;A>0&&(U+=A,W(`resUtility_s${L.id}`,A))}),U>0&&W("resUtility",U)}const x=(ut=s.extHealingStats)==null?void 0:ut.outgoingHealingAllies;Array.isArray(x)&&x.forEach((U,L)=>{const A=O(U,"healing"),B=O(U,"downedHealing");w("healing",L,A),w("downedHealing",L,B)});const K=(st=s.extBarrierStats)==null?void 0:st.outgoingBarrierAllies;Array.isArray(K)&&K.forEach((U,L)=>{const A=O(U,"barrier");w("barrier",L,A)});const ne=(vt=s.statsAll)==null?void 0:vt[0],oe=(Dt=s.dpsAll)==null?void 0:Dt[0],ue=(mt=s.support)==null?void 0:mt[0];if(fs.forEach(U=>{if(U.id==="downContributionPercent"||!U.field)return;let L=0,A=0;U.source==="dpsAll"&&oe?L=Number(oe[U.field]??0):U.source==="statsAll"&&ne?(L=Number(ne[U.field]??0),A=Number(ne[U.denomField||U.weightField||"connectedDamageCount"]??0)):U.source==="support"&&ue?L=Number(ue[U.field]??0):s.statsTargets&&s.statsTargets.forEach(B=>{B!=null&&B[0]&&(L+=Number(B[0][U.field]??0),A+=Number(B[0][U.denomField||U.weightField||"connectedDamageCount"]??0))}),Number.isFinite(L)&&(a.offenseTotals[U.id]=(a.offenseTotals[U.id]||0)+L,U.isRate&&A>0&&(a.offenseRateWeights[U.id]=(a.offenseRateWeights[U.id]||0)+A))}),s.targetDamageDist&&Number.isFinite(b)){const U=s.targetDamageDist.flatMap(L=>L||[]).flatMap(L=>L||[]).reduce((L,A)=>A!=null&&A.id&&A.id===b?L+((A==null?void 0:A.connectedHits)||0):L,0);a.offenseTotals.battleStandardHits=(a.offenseTotals.battleStandardHits||0)+U}a.revives+=((xt=(lt=s.support)==null?void 0:lt[0])==null?void 0:xt.resurrects)||0,oe&&(a.damage+=oe.damage||0,a.dps+=oe.dps||0);const he=U=>{var ae,be;let L=`Skill ${U.id}`;const A=((ae=t.skillMap)==null?void 0:ae[`s${U.id}`])||((be=t.skillMap)==null?void 0:be[`${U.id}`]);let B=A==null?void 0:A.icon;A!=null&&A.name&&(L=A.name);const G=wt(t.buffMap,U.id);if(L.startsWith("Skill ")&&(G!=null&&G.name)&&(L=G.name,B=G.icon||B),L.startsWith("Skill ")){const Pe=Et(L,U.id,t.buffMap);Pe&&(L=Pe,B=(G==null?void 0:G.icon)||B)}return{name:L,icon:B}},Se=U=>{if(!(U!=null&&U.id))return;const{name:L,icon:A}=he(U);Ne[U.id]||(Ne[U.id]={name:L,icon:A,damage:0,hits:0,downContribution:0}),Ne[U.id].name.startsWith("Skill ")&&!L.startsWith("Skill ")&&(Ne[U.id].name=L),!Ne[U.id].icon&&A&&(Ne[U.id].icon=A),Ne[U.id].damage+=U.totalDamage,Ne[U.id].hits+=U.connectedHits,Ne[U.id].downContribution+=Number(U.downContribution||0)},Ie=s.account||s.name||"Unknown",Ce=s.profession||"Unknown",X=`${Ie}|${Ce}`;let fe=Ye.get(X);fe||(fe={key:X,account:Ie,displayName:Ie,profession:Ce,professionList:[Ce],totalFightMs:0,skills:new Map},Ye.set(X,fe)),fe.professionList.includes(Ce)||fe.professionList.push(Ce),fe.totalFightMs+=t.durationMS||0;const Le=U=>{if(!(U!=null&&U.id))return;const{name:L,icon:A}=he(U),B=`s${U.id}`;let G=fe.skills.get(B);G||(G={id:B,name:L,icon:A,damage:0,downContribution:0},fe.skills.set(B,G)),G.name.startsWith("Skill ")&&!L.startsWith("Skill ")&&(G.name=L),!G.icon&&A&&(G.icon=A),G.damage+=Number(U.totalDamage||0),G.downContribution+=Number(U.downContribution||0)};if(re==="total")(Nt=s.totalDamageDist)==null||Nt.forEach(U=>{U==null||U.forEach(L=>{Se(L),Le(L)})});else{const U=new Map;(St=s.targetDamageDist)==null||St.forEach(A=>{A==null||A.forEach(B=>{B==null||B.forEach(G=>{const ae=Number(G==null?void 0:G.id);if(Number.isFinite(ae)){const be=U.get(ae)||{damage:0,hits:0,downContribution:0};be.damage+=Number((G==null?void 0:G.totalDamage)||0),be.hits+=Number((G==null?void 0:G.connectedHits)||0),be.downContribution+=Number((G==null?void 0:G.downContribution)||0),U.set(ae,be)}Se(G),Le(G)})})}),!(t!=null&&t.detailedWvW)&&((Ft=s.totalDamageDist)==null||Ft.forEach(A=>{A==null||A.forEach(B=>{const G=Number(B==null?void 0:B.id);if(!Number.isFinite(G))return;const ae=U.get(G);if(!ae){Se(B),Le(B);return}const be=Number((B==null?void 0:B.totalDamage)||0),Pe=Number((B==null?void 0:B.connectedHits)||0),qe=Number((B==null?void 0:B.downContribution)||0),dt=be-Number(ae.damage||0),Ge=Pe-Number(ae.hits||0),Ze=qe-Number(ae.downContribution||0);if(dt<=0&&Ge<=0&&Ze<=0)return;const kt={...B,totalDamage:Math.max(0,dt),connectedHits:Math.max(0,Ge),downContribution:Math.max(0,Ze)};Se(kt),Le(kt)})}))}s.totalDamageTaken&&s.totalDamageTaken.forEach(U=>{U==null||U.forEach(L=>{var be,Pe;if(!(L!=null&&L.id))return;let A=`Skill ${L.id}`;const B=((be=t.skillMap)==null?void 0:be[`s${L.id}`])||((Pe=t.skillMap)==null?void 0:Pe[`${L.id}`]);let G=B==null?void 0:B.icon;B!=null&&B.name&&(A=B.name);const ae=wt(t.buffMap,L.id);if(A.startsWith("Skill ")&&(ae!=null&&ae.name)&&(A=ae.name,G=ae.icon||G),A.startsWith("Skill ")){const qe=Et(A,L.id,t.buffMap);qe&&(A=qe,G=(ae==null?void 0:ae.icon)||G)}Fe[L.id]||(Fe[L.id]={name:A,icon:G,damage:0,hits:0}),(!Fe[L.id].name.startsWith("Skill ")||A.startsWith("Skill "))&&(Fe[L.id].name=A),!Fe[L.id].icon&&G&&(Fe[L.id].icon=G),Fe[L.id].damage+=L.totalDamage,Fe[L.id].hits+=L.hits})})}),F.forEach(s=>{if(s!=null&&s.isFake)return;const o=rt((s==null?void 0:s.profession)||(s==null?void 0:s.name)||(s==null?void 0:s.id));o&&(We[o]=(We[o]||0)+1)});const S=ls({players:m,targets:F,skillMap:t.skillMap,buffMap:t.buffMap,getPlayerKey:s=>s.account&&s.account!=="Unknown"?s.account:s.name||null}),C=Nn(t.buffMap);Object.entries(S.playerConditions).forEach(([s,o])=>{const g=pe.get(s);g&&Object.entries(o).forEach(([_,u])=>{const a=g.outgoingConditions[_]||{applications:0,damage:0,skills:{},icon:u.icon};a.applications+=Number(u.applications||0),a.damage+=Number(u.damage||0),u.applicationsFromBuffs&&(a.applicationsFromBuffs=(a.applicationsFromBuffs||0)+u.applicationsFromBuffs),u.applicationsFromBuffsActive&&(a.applicationsFromBuffsActive=(a.applicationsFromBuffsActive||0)+u.applicationsFromBuffsActive),Object.entries(u.skills||{}).forEach(([V,p])=>{const D=a.skills[V]||{name:p.name,hits:0,damage:0,icon:p.icon};D.hits+=Number(p.hits||0),D.damage+=Number(p.damage||0),!D.icon&&p.icon&&(D.icon=p.icon),a.skills[V]=D}),!a.icon&&u.icon&&(a.icon=u.icon),g.outgoingConditions[_]=a})}),Object.entries(S.summary).forEach(([s,o])=>{const g=Qe[s]||{name:o.name||s,icon:o.icon,applications:0,damage:0};g.applications+=Number(o.applications||0),g.damage+=Number(o.damage||0),o.applicationsFromBuffs&&(g.applicationsFromBuffs=(g.applicationsFromBuffs||0)+o.applicationsFromBuffs),o.applicationsFromBuffsActive&&(g.applicationsFromBuffsActive=(g.applicationsFromBuffsActive||0)+o.applicationsFromBuffsActive),!g.icon&&o.icon&&(g.icon=o.icon),Qe[s]=g}),k.forEach(s=>{const o=s.account&&s.account!=="Unknown"?s.account:s.name||"Unknown",g=pe.get(o);!g||!s.totalDamageTaken||s.totalDamageTaken.forEach(_=>_==null?void 0:_.forEach(u=>{var ue,he;if(!(u!=null&&u.id))return;let a=`Skill ${u.id}`;const V=((ue=t.skillMap)==null?void 0:ue[`s${u.id}`])||((he=t.skillMap)==null?void 0:he[`${u.id}`]);V!=null&&V.name&&(a=V.name);const p=wt(t.buffMap,u.id);a.startsWith("Skill ")&&(p!=null&&p.name)&&(a=p.name);const D=Et(a,u.id,t.buffMap);if(!D)return;const q=p==null?void 0:p.name,W=C.get(D)||(p==null?void 0:p.icon),O=(V==null?void 0:V.icon)||(p==null?void 0:p.icon)||W;a.startsWith("Skill ")&&(q||D)&&(a=q||D);const w=Number(u.hits??0),x=Number(u.totalDamage??0),K=tt[D]||{name:D,icon:W,applications:0,damage:0};K.applications+=Number.isFinite(w)?w:0,K.damage+=Number.isFinite(x)?x:0,!K.icon&&W&&(K.icon=W),tt[D]=K;const ne=g.incomingConditions[D]||{applications:0,damage:0,skills:{},icon:W};ne.applications+=Number.isFinite(w)?w:0,ne.damage+=Number.isFinite(x)?x:0;const oe=ne.skills[a]||{name:a,hits:0,damage:0,icon:O};oe.hits+=Number.isFinite(w)?w:0,oe.damage+=Number.isFinite(x)?x:0,!oe.icon&&O&&(oe.icon=O),ne.skills[a]=oe,!ne.icon&&W&&(ne.icon=W),g.incomingConditions[D]=ne}))});const I=t.player_damage_mitigation||t.playerDamageMitigation,P=I&&typeof I=="object"&&Object.keys(I).length>0;P&&Object.entries(I).forEach(([s,o])=>{if(!o||typeof o!="object")return;const g=Fn(s),_=Bn(zt,g.account,g);Object.values(o).forEach(u=>{Re((u==null?void 0:u.avoided_damage)??(u==null?void 0:u.avoidedDamage))<=0||In(_.mitigationTotals,u)})});const n=t.player_minion_damage_mitigation||t.playerMinionDamageMitigation,i=n&&typeof n=="object"&&Object.keys(n).length>0;i&&Object.entries(n).forEach(([s,o])=>{if(!o||typeof o!="object")return;const g=Fn(s);Object.entries(o).forEach(([_,u])=>{if(!u||typeof u!="object")return;const a=`${g.account}::${_}`,V=En(Kt,a,{...g,minion:String(_||"Unknown")});Object.values(u).forEach(p=>{In(V.mitigationTotals,p)})})}),(!P||!i)&&(P||k.forEach(s=>{const o=(s==null?void 0:s.totalDamageTaken)||[];if(!Array.isArray(o)||o.length===0)return;const g=s.account||s.name||"Unknown",_={account:g,name:s.name||g,profession:rt(s.profession||"Unknown")};Bn(zt,g,_);const u=Array.isArray(o)?o[0]:null;u==null||u.forEach(a=>{if(!(a!=null&&a.id))return;const V=Re(a.blocked),p=Re(a.evaded),D=Re(a.glance??a.glanced),q=Re(a.missed),W=Re(a.invulned),O=Re(a.interrupted),w=Re(a.hits??a.connectedHits),x=Number(a.id);Ln(Pn,`${g}::${x}`,{totalHits:w,blocked:V,evaded:p,glanced:D,missed:q,invulned:W,interrupted:O})})}),i||k.forEach(s=>{const o=(s==null?void 0:s.minions)||[];if(!Array.isArray(o)||o.length===0)return;const g=s.account||s.name||"Unknown",_={account:g,name:s.name||g,profession:rt(s.profession||"Unknown")};o.forEach(u=>{const a=(u==null?void 0:u.totalDamageTakenDist)||[];if(!Array.isArray(a)||a.length===0)return;let V=String((u==null?void 0:u.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";V.toUpperCase().includes("UNKNOWN")&&(V="Unknown");const p=`${g}::${V}`;En(Kt,p,{..._,minion:V});const D=Array.isArray(a)?a[0]:null;D==null||D.forEach(q=>{if(!(q!=null&&q.id))return;const W=Re(q.blocked),O=Re(q.evaded),w=Re(q.glance??q.glanced),x=Re(q.missed),K=Re(q.invulned),ne=Re(q.interrupted),oe=Re(q.hits??q.connectedHits),ue=Number(q.id);Ln(xn,`${p}::${ue}`,{totalHits:oe,blocked:W,evaded:O,glanced:w,missed:x,invulned:K,interrupted:ne})})})}))});const Un=(e,t)=>{const m=new Map,F=f=>{let j=m.get(f);return j||(j=Pt(),m.set(f,j)),j};t.forEach((f,j)=>{const T=j.lastIndexOf("::"),Z=T>-1?j.slice(0,T):j,J=T>-1?Number(j.slice(T+2)):Number.NaN,ie=Number.isFinite(J)?Ts(J):{hasSkill:!1,avg:0,min:0,hits:0};if(!ie.hasSkill||ie.hits<=0)return;const E=ie.avg,l=ie.min,d=f.glanced*E/2+(f.blocked+f.evaded+f.missed+f.invulned+f.interrupted)*E,$=f.glanced*l/2+(f.blocked+f.evaded+f.missed+f.invulned+f.interrupted)*l;if(d<=0)return;const k=F(Z);k.totalHits+=f.totalHits,k.blocked+=f.blocked,k.evaded+=f.evaded,k.glanced+=f.glanced,k.missed+=f.missed,k.invulned+=f.invulned,k.interrupted+=f.interrupted,k.totalMitigation+=d,k.minMitigation+=$}),e.forEach((f,j)=>{const T=m.get(j)||Pt();f.mitigationTotals.totalHits=T.totalHits,f.mitigationTotals.blocked=T.blocked,f.mitigationTotals.evaded=T.evaded,f.mitigationTotals.glanced=T.glanced,f.mitigationTotals.missed=T.missed,f.mitigationTotals.invulned=T.invulned,f.mitigationTotals.interrupted=T.interrupted,f.mitigationTotals.totalMitigation=T.totalMitigation,f.mitigationTotals.minMitigation=T.minMitigation})};Un(zt,Pn),Un(Kt,xn);const vs=me>0?Math.round(ce/me):0,Fs=me>0?Math.round(ve/me):0,Bs=nt>0?(v/nt).toFixed(2):v>0?"∞":"0.00",Es=de>0?(De/de).toFixed(2):De>0?"∞":"0.00",qn=(e,t)=>{const F=e.filter(T=>Number.isFinite(T.value)&&(t?T.value>0:T.value>=0)).sort((T,Z)=>{const J=t?Z.value-T.value:T.value-Z.value;return J!==0?J:T.account.localeCompare(Z.account)});let f=null,j=0;return F.map((T,Z)=>((f===null||T.value!==f)&&(j=Z+1,f=T.value),{rank:j,...T}))},tn=Array.from(pe.values()).map(e=>{const t=Array.from(e.professions).filter(m=>m!=="Unknown");if(e.professionList=t,t.length>0){let m=t[0],F=e.professionTimeMs[m]||0;t.forEach(f=>{const j=e.professionTimeMs[f]||0;j>F&&(F=j,m=f)}),e.profession=m}return{key:e.account,stat:e}}),_n=e=>{const t=pe.get(e.account);if(!t){const f=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:f}}const m=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(f=>f&&f!=="Unknown"),F=t.profession||e.profession;return{...e,profession:F,professionList:m.length>0?m:F?[F]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Is=Array.from(zt.values()).map(_n).filter(e=>ws(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Ps=Array.from(Kt.values()).map(_n).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const m=e.account.localeCompare(t.account);return m!==0?m:String(e.minion||"").localeCompare(String(t.minion||""))}),Vt=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},ct=(e,t)=>qn(tn.map(({stat:m})=>({account:m.account,profession:m.profession,professionList:m.professionList,value:Vt(m,e),count:m.logsJoined})),t),Oe={downContrib:ct("downContrib",!0),barrier:ct("barrier",!0),healing:ct("healing",!0),dodges:ct("dodges",!0),strips:ct("strips",!0),cleanses:ct("cleanses",!0),cc:ct("cc",!0),stability:ct("stability",!0),revives:ct("revives",!0),participation:ct("participation",!0),dps:ct("dps",!0),damage:ct("damage",!0),closestToTag:ct("closestToTag",!1).filter(e=>Number.isFinite(e.value))},xs={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},xe=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},ht={maxDownContrib:xe([]),maxBarrier:xe([]),maxHealing:xe([]),maxDodges:xe([]),maxStrips:xe([]),maxCleanses:xe([]),maxCC:xe([]),maxStab:xe([]),closestToTag:xe([])},gt={},Ls=(e,t)=>{if(t==="closestToTag")return Vt(e,t);const m=Math.max(1,(e.totalFightMs||0)/1e3);return Vt(e,t)/m};Object.values(xs).forEach(e=>{const t=e!=="closestToTag";gt[e]=qn(tn.map(({stat:m})=>({account:m.account,profession:m.profession,professionList:m.professionList,value:Ls(m,e),count:m.logsJoined})),t)}),ht.maxDownContrib=xe(gt.downContrib),ht.maxBarrier=xe(gt.barrier),ht.maxHealing=xe(gt.healing),ht.maxDodges=xe(gt.dodges),ht.maxStrips=xe(gt.strips),ht.maxCleanses=xe(gt.cleanses),ht.maxCC=xe(gt.cc),ht.maxStab=xe(gt.stability),ht.closestToTag=xe(gt.closestToTag);const Us={maxDownContrib:xe(Oe.downContrib),maxBarrier:xe(Oe.barrier),maxHealing:xe(Oe.healing),maxDodges:xe(Oe.dodges),maxStrips:xe(Oe.strips),maxCleanses:xe(Oe.cleanses),maxCC:xe(Oe.cc),maxStab:xe(Oe.stability),closestToTag:xe(Oe.closestToTag)};let nn={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},$n,Rn,Wn=0;if(ge!=null&&ge.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=j=>{const T=e[j];return T?Number(Me[T]||0)>0:!1},m=[],F=j=>[...j||[]].filter(T=>t(T==null?void 0:T.name)).sort((T,Z)=>Z.ratio-T.ratio||T.rank-Z.rank||T.name.localeCompare(Z.name)).slice(0,3),f=j=>{var Z;if(!j)return;const T=F(j.contribs);return{...j,player:j.name,reason:((Z=T[0])==null?void 0:Z.name)||"Top Performance",topStats:T}};tn.forEach(({stat:j})=>{let T=0;const Z=[],J=(ie,E,l,d,$=!0)=>{var R,H;if(l<=0)return;const k=((R=E[0])==null?void 0:R.value)||0;if(k&&Number.isFinite(ie)&&($?ie>0:ie<Number.POSITIVE_INFINITY)){const Q=$?ie/k:k/ie;T+=Q*l;const b=((H=E.find(S=>S.account===j.account))==null?void 0:H.rank)||0;Z.push({name:d,ratio:Q,val:ie.toLocaleString(),rank:b})}};J(j.downContrib,Oe.downContrib,Me.downContribution,"Down Contribution"),J(j.healing,Oe.healing,Me.healing,"Healing"),J(j.cleanses,Oe.cleanses,Me.cleanses,"Cleanses"),J(j.strips,Oe.strips,Me.strips,"Strips"),J(j.stab,Oe.stability,Me.stability,"Stability"),J(j.cc,Oe.cc,Me.cc,"CC"),J(j.revives,Oe.revives,Me.revives,"Revives"),J(Vt(j,"closestToTag"),Oe.closestToTag,Me.distanceToTag,"Distance to Tag",!1),J(j.logsJoined,Oe.participation,Me.participation,"Participation"),J(j.dodges,Oe.dodges,Me.dodging,"Dodging"),J(j.dps,Oe.dps,Me.dps,"DPS"),J(j.damage,Oe.damage,Me.damage,"Damage"),m.push({...j,score:T,contribs:Z.filter(ie=>t(ie.name))})}),m.sort((j,T)=>T.score-j.score),m[0]&&m[0].score>0&&(nn=f(m[0])||nn),$n=f(m[1]),Rn=f(m[2]),Wn=m.length>0?m.reduce((j,T)=>j+T.score,0)/m.length:0}const On=Object.values(Ne).sort((e,t)=>t.damage-e.damage||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),Hn=Object.values(Ne).sort((e,t)=>t.downContribution-e.downContribution||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),qs=ke==="downContribution"?Hn:On,_s=Object.values(Fe).sort((e,t)=>t.damage-e.damage).slice(0,25),$s=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),m=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return m?`${m[1]} Borderlands`:t||"Unknown"},bt=(e,t)=>$s((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Rs=(e,t)=>{const m=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof m=="string"&&m.trim().length>0)return m.trim();const F=e==null?void 0:e.uploadLinks;if(!Array.isArray(F))return"";for(const f of F){if(typeof f=="string"&&f.trim().length>0)return f.trim();if(f&&typeof f=="object"){const j=f.permalink||f.link||f.url||f.reportLink;if(typeof j=="string"&&j.trim().length>0)return j.trim()}}return""},Ws=(e,t)=>{const m=Number((e==null?void 0:e.durationMS)||0);return m>0?Tt(m):(typeof(t==null?void 0:t.encounterDuration)=="string"?t.encounterDuration.trim():"")||"--:--"},jn=(e,t)=>{if((Array.isArray(e==null?void 0:e.players)?e.players:[]).length>0)return Te(e);if(typeof(e==null?void 0:e.success)=="boolean")return e.success;const F=t==null?void 0:t.dashboardSummary;if(F&&typeof F=="object"){if(F.isWin===!0)return!0;if(F.isWin===!1)return!1}return null},Os=(e,t)=>{var T,Z;const m=ze((T=e.log)==null?void 0:T.details,e.log),F=ze((Z=t.log)==null?void 0:Z.details,t.log),f=m>0,j=F>0;return f&&j&&m!==F?m-F:f!==j?f?-1:1:e.originalIndex-t.originalIndex},sn=c.map((e,t)=>({log:e,originalIndex:t})).sort(Os),zn=sn.filter(({log:e})=>Ae(e)),on={};se.forEach(e=>{const t=bt(e==null?void 0:e.details,e);on[t]=(on[t]||0)+1});const Hs=Object.entries(on).map(([e,t])=>{const m=String(e).trim(),F=/eternal battlegrounds|^ebg$/i.test(m);let f="#64748b";return F?f="#ffffff":/red/i.test(m)?f="#ef4444":/blue/i.test(m)?f="#3b82f6":/green/i.test(m)&&(f="#22c55e"),{name:e,value:t,color:f}}).sort((e,t)=>t.value-e.value),{boonTables:js}=Vn(se),zs=(()=>{const e=l=>String(l||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=l=>e(l).toLowerCase().split(/[^a-z0-9]+/i).map(d=>d.trim()).filter(Boolean).map(d=>d.length>3&&d.endsWith("s")?d.slice(0,-1):d),m=(l,d)=>{const $=e(l),k=e(d);if(!k)return $;if(!$)return k;const R=t($),H=t(k),Q=new Set(R),b=new Set(H),S=H.length>0&&H.every(I=>Q.has(I)),C=R.length>0&&R.every(I=>b.has(I));return S||C?$:`${$} - ${k}`},F=new Map,f=(l,d)=>{if(!F.has(l))F.set(l,{id:l,name:String((d==null?void 0:d.name)||l),icon:d==null?void 0:d.icon,stacking:!!(d!=null&&d.stacking),players:new Map,fights:[]});else if(d){const $=F.get(l);(!$.name||$.name===l)&&(d!=null&&d.name)&&($.name=String(d.name)),!$.icon&&(d!=null&&d.icon)&&($.icon=String(d.icon)),!$.stacking&&(d!=null&&d.stacking)&&($.stacking=!0)}return F.get(l)},j=l=>Array.isArray(l)?l.map(d=>Array.isArray(d)?[Number(d[0]),Number(d[1])]:d&&typeof d=="object"?[Number(d.time),Number(d.value)]:null).filter(d=>!!d&&Number.isFinite(d[0])&&Number.isFinite(d[1])&&d[0]>=0).sort((d,$)=>d[0]-$[0]):[],T=(l,d,$)=>{const k=l.get(d)||[];k.length<$&&(k.length=$);for(let R=0;R<$;R+=1)Number.isFinite(k[R])||(k[R]=0);return l.set(d,k),k},Z=(l,d,$,k,R)=>{if(!d||d==="__all__"||k<=0)return;const H=j($);if(H.length===0)return;const Q=T(l,d,k),b=Math.max(1,Number(R||0),k*5e3),S=n=>Math.max(0,Math.min(b,Number(n||0))),C=(n,i,r)=>{if(!Number.isFinite(r)||r<=0)return;let N=S(n);const s=S(i);if(!(s<=N))for(;N<s;){const o=Math.max(0,Math.min(k-1,Math.floor(N/5e3))),g=Math.min(s,(o+1)*5e3),_=Math.max(0,g-N);_>0&&(Q[o]=Number(Q[o]||0)+_*r),N=g}};let I=S(H[0][0]),P=Math.max(0,Number(H[0][1]||0));for(let n=1;n<H.length;n+=1){const[i,r]=H[n],N=S(i);C(I,N,P),I=N,P=Math.max(0,Number(r||0))}C(I,b,P)},J=(l,d,$)=>{const k=Array.from({length:$},(Q,b)=>Number((l==null?void 0:l[b])||0)),R=k.reduce((Q,b)=>Q+Number(b||0),0);if(!Number.isFinite(d)||d<=0)return k.map(()=>0);if(!Number.isFinite(R)||R<=0){const Q=d/Math.max(1,$);return k.map(()=>Q)}const H=d/R;return k.map(Q=>Number(Q||0)*H)},ie=()=>({selfBuffs:0,groupBuffs:0,squadBuffs:0,totalBuffs:0}),E=(l,d,$)=>{const k=Math.max(0,Number($||0));k&&(l[d]=Number(l[d]||0)+k,(d==="selfBuffs"||d==="squadBuffs")&&(l.totalBuffs=Number(l.totalBuffs||0)+k))};return se.map(l=>({log:l,ts:ze(l==null?void 0:l.details,l)})).sort((l,d)=>l.ts-d.ts).forEach(({log:l},d)=>{const $=l==null?void 0:l.details;if(!$)return;const R=(Array.isArray($.players)?$.players:[]).filter(o=>!(o!=null&&o.notInSquad)),H=R.length;if(H<=0)return;const Q=Math.max(0,Number(($==null?void 0:$.durationMS)||0)),b=Math.max(1,Math.ceil(Math.max(1,Q)/5e3)),S=$!=null&&$.buffMap&&typeof $.buffMap=="object"?$.buffMap:{},C=new Map,I=new Map;R.forEach(o=>{const g=Number((o==null?void 0:o.group)??0);I.set(g,(I.get(g)||0)+1);const u=String((o==null?void 0:o.account)||(o==null?void 0:o.name)||"Unknown");[o==null?void 0:o.name,o==null?void 0:o.display_name,o==null?void 0:o.character_name,o==null?void 0:o.account].map(a=>String(a||"").trim()).filter(Boolean).forEach(a=>C.set(a,u))});const P=e($.fightName||l.fightName||`Fight ${d+1}`),n=bt($,l),i=m(P,String(n||"")),r=new Map,N=new Map,s=new Map;R.forEach(o=>{const g=String((o==null?void 0:o.account)||(o==null?void 0:o.name)||"Unknown"),_=String((o==null?void 0:o.profession)||"Unknown"),u=g,a=Number((o==null?void 0:o.group)??0),V=Math.max(1,Number(I.get(a)||1));["selfBuffs","groupBuffs","squadBuffs"].forEach(D=>{(Array.isArray(o==null?void 0:o[D])?o[D]:[]).forEach(W=>{var Ve;const O=Number(W==null?void 0:W.id);if(!Number.isFinite(O))return;const w=`b${O}`,x=S[w]||{},K=String((x==null?void 0:x.classification)||"");if(K&&K!=="Boon")return;const ne=Number(((Ve=Jt(o,D,O,Q,V,H,S))==null?void 0:Ve.generationMs)||0);if(!Number.isFinite(ne)||ne<=0)return;const oe=f(w,x),ue=oe.players.get(u)||{key:u,account:g,displayName:g,profession:_,professionList:_&&_!=="Unknown"?[_]:[],logs:0,totals:ie()};_&&_!=="Unknown"&&!ue.professionList.includes(_)&&ue.professionList.push(_),(!ue.profession||ue.profession==="Unknown")&&_&&_!=="Unknown"&&(ue.profession=_);const he=s.get(w)||new Set;he.has(u)||(he.add(u),ue.logs+=1,s.set(w,he)),E(ue.totals,D,ne),oe.players.set(u,ue);const Se=oe.players.get("__all__")||{key:"__all__",account:"All",displayName:"All",profession:"All",professionList:[],logs:0,totals:ie()};E(Se.totals,D,ne),oe.players.set("__all__",Se);const Ie=r.get(w)||new Map,Ce=Ie.get(u)||ie();E(Ce,D,ne),Ie.set(u,Ce);const X=Ie.get("__all__")||ie();E(X,D,ne),Ie.set("__all__",X),r.set(w,Ie);const fe=Array.isArray(o==null?void 0:o.buffUptimes)?o.buffUptimes.find(Ue=>Number(Ue==null?void 0:Ue.id)===O):null,Le=fe!=null&&fe.statesPerSource&&typeof fe.statesPerSource=="object"?fe.statesPerSource:null;if(Le){const Ue=N.get(w)||new Map;Object.entries(Le).forEach(([$e,ut])=>{const st=C.get(String($e||"").trim());st&&Z(Ue,st,ut,b,Q)}),N.set(w,Ue)}})})}),r.forEach((o,g)=>{const _=F.get(g);if(!_)return;const u=N.get(g)||new Map,a={};let V=Array.from({length:b},()=>0),p=0;o.forEach((O,w)=>{const x={selfBuffs:Number((O==null?void 0:O.selfBuffs)||0),groupBuffs:Number((O==null?void 0:O.groupBuffs)||0),squadBuffs:Number((O==null?void 0:O.squadBuffs)||0),totalBuffs:Number((O==null?void 0:O.totalBuffs)||0)},K=Math.max(0,Number(x.totalBuffs||0));if(!Number.isFinite(K)||K<=0)return;const ne=u.get(w)||[],oe=J(ne,K,b);a[w]={total:K,totals:x,bucketWeights5s:Array.from({length:b},(ue,he)=>Number(ne[he]||0)),buckets5s:oe},w!=="__all__"&&(K>p&&(p=K),V=V.map((ue,he)=>Number(ue||0)+Number(oe[he]||0)))});const D=o.get("__all__"),q=Number((D==null?void 0:D.totalBuffs)||0);if(q>0&&(a.__all__={total:q,totals:{selfBuffs:Number((D==null?void 0:D.selfBuffs)||0),groupBuffs:Number((D==null?void 0:D.groupBuffs)||0),squadBuffs:Number((D==null?void 0:D.squadBuffs)||0),totalBuffs:Number((D==null?void 0:D.totalBuffs)||0)},bucketWeights5s:Array.from({length:b},(O,w)=>Number((u.get("__all__")||[])[w]||0)),buckets5s:V.some(O=>Number(O||0)>0)?V:J(u.get("__all__")||[],q,b)}),Object.keys(a).length===0)return;const W=_.players.get("__all__");W&&(W.logs+=1,_.players.set("__all__",W)),_.fights.push({id:l.filePath||l.id||`fight-${d+1}`,shortLabel:`F${d+1}`,fullLabel:i,timestamp:ze($,l),durationMs:Q,values:a,maxTotal:p})})}),Array.from(F.values()).map(l=>({id:l.id,name:l.name||l.id,icon:l.icon,stacking:l.stacking,players:Array.from(l.players.values()).sort((d,$)=>{var R,H;if(d.key==="__all__")return-1;if($.key==="__all__")return 1;const k=Number(((R=$.totals)==null?void 0:R.totalBuffs)||0)-Number(((H=d.totals)==null?void 0:H.totalBuffs)||0);return k!==0?k:String(d.displayName||"").localeCompare(String($.displayName||""))}),fights:[...l.fights].sort((d,$)=>d.timestamp>0&&$.timestamp>0&&d.timestamp!==$.timestamp?d.timestamp-$.timestamp:d.shortLabel.localeCompare($.shortLabel,void 0,{numeric:!0}))})).filter(l=>l.players.length>0&&l.fights.length>0).sort((l,d)=>String(l.name||"").localeCompare(String(d.name||"")))})(),Ks=(()=>{const e=E=>String(E||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=E=>e(E).toLowerCase().split(/[^a-z0-9]+/i).map(l=>l.trim()).filter(Boolean).map(l=>l.length>3&&l.endsWith("s")?l.slice(0,-1):l),m=(E,l)=>{const d=e(E),$=e(l);if(!$)return d;if(!d)return $;const k=t(d),R=t($),H=new Set(k),Q=new Set(R),b=R.length>0&&R.every(C=>H.has(C)),S=k.length>0&&k.every(C=>Q.has(C));return b||S?d:`${d} - ${$}`},F=new Map,f=(E,l)=>{if(!F.has(E))F.set(E,{id:E,name:String((l==null?void 0:l.name)||E),icon:l==null?void 0:l.icon,stacking:!!(l!=null&&l.stacking),players:new Map,fights:[]});else if(l){const d=F.get(E);(!d.name||d.name===E)&&(l!=null&&l.name)&&(d.name=String(l.name)),!d.icon&&(l!=null&&l.icon)&&(d.icon=String(l.icon)),!d.stacking&&(l!=null&&l.stacking)&&(d.stacking=!0)}return F.get(E)},j=E=>Array.isArray(E)?E.map(l=>Array.isArray(l)?[Number(l[0]),Number(l[1])]:l&&typeof l=="object"?[Number(l.time),Number(l.value)]:null).filter(l=>!!l&&Number.isFinite(l[0])&&Number.isFinite(l[1])&&l[0]>=0).sort((l,d)=>l[0]-d[0]):[],T=(E,l)=>{if(!l)return 1;const d=String(E||"").trim().toLowerCase();return 25},Z=(E,l,d)=>{const $=Number.isFinite(E)?Math.max(0,E):0;return l?Math.max(0,Math.min(d,Math.round($))):$>0?1:0},J=(E,l,d,$)=>{const k=Array.from({length:l},()=>0);if(!E||typeof E!="object"||l<=0)return k;Object.values(E).forEach(H=>{const Q=j(H);if(Q.length===0)return;let b=0,S=0;for(let C=0;C<l;C+=1){const I=C*5e3;for(;b<Q.length&&Q[b][0]<=I;)S=Math.max(0,Number(Q[b][1]||0)),b+=1;k[C]+=Math.max(0,Number(S||0))}});const R=T($,d);return k.map(H=>Z(H,d,R))},ie=E=>{const l=E.reduce(($,k)=>$+Math.max(0,Number(k||0)),0),d=E.reduce(($,k)=>Math.max($,Math.max(0,Number(k||0))),0);return{total:l,peak:d,buckets5s:E}};return se.map(E=>({log:E,ts:ze(E==null?void 0:E.details,E)})).sort((E,l)=>E.ts-l.ts).forEach(({log:E},l)=>{const d=E==null?void 0:E.details;if(!d)return;const k=(Array.isArray(d.players)?d.players:[]).filter(n=>!(n!=null&&n.notInSquad));if(k.length<=0)return;const R=Math.max(0,Number((d==null?void 0:d.durationMS)||0)),H=Math.max(1,Math.ceil(Math.max(1,R)/5e3)),Q=d!=null&&d.buffMap&&typeof d.buffMap=="object"?d.buffMap:{},b=e(d.fightName||E.fightName||`Fight ${l+1}`),S=bt(d,E),C=m(b,String(S||"")),I=new Map,P=new Map;k.forEach(n=>{const i=String((n==null?void 0:n.account)||(n==null?void 0:n.name)||"Unknown"),r=i,N=String((n==null?void 0:n.profession)||"Unknown");(Array.isArray(n==null?void 0:n.buffUptimes)?n.buffUptimes:[]).forEach(o=>{const g=Number(o==null?void 0:o.id);if(!Number.isFinite(g))return;const _=`b${g}`,u=Q[_]||{},a=String((u==null?void 0:u.classification)||"");if(a&&a!=="Boon")return;const V=o!=null&&o.statesPerSource&&typeof o.statesPerSource=="object"?o.statesPerSource:null;if(!V)return;const p=J(V,H,!!(u!=null&&u.stacking),String((u==null?void 0:u.name)||"")),D=ie(p);if(D.total<=0&&D.peak<=0)return;const q=f(_,u),W=q.players.get(r)||{key:r,account:i,displayName:i,profession:N,professionList:N&&N!=="Unknown"?[N]:[],logs:0,total:0,peak:0};N&&N!=="Unknown"&&!W.professionList.includes(N)&&W.professionList.push(N),(!W.profession||W.profession==="Unknown")&&N&&N!=="Unknown"&&(W.profession=N);const O=P.get(_)||new Set;O.has(r)||(O.add(r),W.logs+=1,P.set(_,O)),W.total+=D.total,W.peak=Math.max(W.peak,D.peak),q.players.set(r,W);const w=I.get(_)||new Map;w.set(r,D),I.set(_,w)})}),I.forEach((n,i)=>{const r=F.get(i);if(!r)return;const N={};let s=0;n.forEach((o,g)=>{N[g]={total:Number(o.total||0),peak:Number(o.peak||0),buckets5s:Array.isArray(o.buckets5s)?o.buckets5s.map(_=>Number(_||0)):[]},s=Math.max(s,Number(o.peak||0))}),Object.keys(N).length!==0&&r.fights.push({id:E.filePath||E.id||`fight-${l+1}`,shortLabel:`F${l+1}`,fullLabel:C,timestamp:ze(d,E),durationMs:R,values:N,maxTotal:s})})}),Array.from(F.values()).map(E=>({id:E.id,name:E.name||E.id,icon:E.icon,stacking:E.stacking,players:Array.from(E.players.values()).sort((l,d)=>{const $=Number(d.peak||0)-Number(l.peak||0);if($!==0)return $;const k=Number(d.total||0)-Number(l.total||0);return k!==0?k:String(l.displayName||"").localeCompare(String(d.displayName||""))}),fights:[...E.fights].sort((l,d)=>l.timestamp>0&&d.timestamp>0&&l.timestamp!==d.timestamp?l.timestamp-d.timestamp:l.shortLabel.localeCompare(d.shortLabel,void 0,{numeric:!0}))})).filter(E=>E.players.length>0&&E.fights.length>0).sort((E,l)=>String(E.name||"").localeCompare(String(l.name||"")))})(),Vs=sn.map(({log:e})=>{const t=e==null?void 0:e.details,m=Array.isArray(t==null?void 0:t.players)?t.players:[],F=Array.isArray(t==null?void 0:t.targets)?t.targets:[],f=e!=null&&e.dashboardSummary&&typeof e.dashboardSummary=="object"?e.dashboardSummary:null,j=m.filter(d=>!d.notInSquad),T=F.filter(d=>!d.isFake),Z=Math.max(0,Number((f==null?void 0:f.squadCount)||0)),J=Math.max(0,Number((f==null?void 0:f.enemyCount)||0)),ie=j.length>0?j.length:Z,E=T.length>0?T.length:J,l=m.length>0?m.length:ie;return{timestamp:ze(t,e),squadCount:ie,friendlyCount:l,enemies:E,isWin:jn(t,e)}}).map((e,t)=>({...e,index:t+1,label:`Log ${t+1}`})),an={};Array.from(pe.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(an[e.profession]=(an[e.profession]||0)+1)});const Gs=Object.entries(an).map(([e,t])=>({name:e,value:t,color:Sn(e)})).sort((e,t)=>t.value-e.value),rn={};Object.keys(We).length===0&&se.forEach(e=>{var t,m;(m=(t=e.details)==null?void 0:t.targets)==null||m.forEach(F=>{if(F.isFake)return;const f=F.profession&&F.profession!=="Unknown"?F.profession:F.name||F.id||"Unknown",j=rt(f);rn[j]=(rn[j]||0)+1})});const Ys=Object.keys(We).length>0?We:rn,Js=Object.entries(Ys).map(([e,t])=>({name:e,value:t,color:Sn(e)})).sort((e,t)=>t.value-e.value),Xs=sn.map(({log:e},t)=>{const m=e==null?void 0:e.details,F=Array.isArray(m==null?void 0:m.players)?m.players:[],f=F.filter(i=>!i.notInSquad),j=F.filter(i=>i.notInSquad),Z=(Array.isArray(m==null?void 0:m.targets)?m.targets:[]).filter(i=>!i.isFake),J=e!=null&&e.dashboardSummary&&typeof e.dashboardSummary=="object"?e.dashboardSummary:null,ie=f.reduce((i,r)=>{var N,s;return i+(((s=(N=r.dpsAll)==null?void 0:N[0])==null?void 0:s.damage)||0)},0),E=f.reduce((i,r)=>{var N,s;return i+(((s=(N=r.defenses)==null?void 0:N[0])==null?void 0:s.damageTaken)||0)},0),{enemyDeaths:l,enemyDownsDeaths:d}=we(m),$=jn(m,e),k=ze(m,e),R=bt(m,e),H=i=>{if(!i||typeof i!="object")return;const r=i.teamID??i.teamId??i.team??i.teamColor??i.team_color;if(r!=null)return r;const N=Object.keys(i).find(s=>/^team/i.test(s));return N?i[N]:void 0},Q=(i,r)=>{const N={};return i.forEach(s=>{const o=r(s),g=rt(o);g&&(N[g]=(N[g]||0)+1)}),N},b=Q(f,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),S=Q(j,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),C=Q(Z,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)||(i==null?void 0:i.id)),I=new Set;f.forEach(i=>{const r=H(i);r!=null&&I.add(String(r))});const P=new Map;Z.forEach(i=>{if((i==null?void 0:i.enemyPlayer)===!1)return;const r=H(i);if(r==null)return;const N=String(r);I.has(N)||P.set(N,(P.get(N)||0)+1)});const n=Array.from(P.entries()).sort((i,r)=>{const N=r[1]-i[1];return N!==0?N:i[0].localeCompare(r[0],void 0,{numeric:!0})}).slice(0,3).map(([i,r])=>({teamId:i,count:r}));return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Rs(m,e),timestamp:k,mapName:R,duration:Ws(m,e),isWin:$,squadCount:f.length>0?f.length:Math.max(0,Number((J==null?void 0:J.squadCount)||0)),allyCount:j.length,enemyCount:Z.length>0?Z.length:Math.max(0,Number((J==null?void 0:J.enemyCount)||0)),teamBreakdown:n,alliesDown:f.reduce((i,r)=>{var N,s;return i+(((s=(N=r.defenses)==null?void 0:N[0])==null?void 0:s.downCount)||0)},0),alliesDead:f.length>0?f.reduce((i,r)=>{var N,s;return i+(((s=(N=r.defenses)==null?void 0:N[0])==null?void 0:s.deadCount)||0)},0):Math.max(0,Number((J==null?void 0:J.squadDeaths)||0)),alliesRevived:f.reduce((i,r)=>{var N,s;return Number(((s=(N=r.statsAll)==null?void 0:N[0])==null?void 0:s.saved)||0)>0?i+1:i},0),rallies:0,enemyDeaths:Z.length>0||f.length>0?l:Math.max(0,Number((J==null?void 0:J.enemyDeaths)||0)),enemyDowns:Math.max(0,d-l),totalOutgoingDamage:ie,totalIncomingDamage:E,incomingBarrierAbsorbed:f.reduce((i,r)=>{var N,s;return i+(((s=(N=r.defenses)==null?void 0:N[0])==null?void 0:s.damageBarrier)||0)},0),outgoingBarrierAbsorbed:f.reduce((i,r)=>{var o;const N=(o=r.extBarrierStats)==null?void 0:o.outgoingBarrier;if(!Array.isArray(N))return i;let s=0;return N.forEach(g=>{if(Array.isArray(g)){g.forEach(_=>{s+=Number((_==null?void 0:_.barrier)||0)});return}s+=Number((g==null?void 0:g.barrier)||0)}),i+s},0),squadClassCountsFight:b,allyClassCountsFight:S,enemyClassCounts:C}}),Qs=(()=>{const e=(n,i)=>{const r=Array.isArray(n==null?void 0:n.buffUptimes)?n.buffUptimes:[];let N=0,s=0;return r.forEach(o=>{var p,D,q,W;if(typeof(o==null?void 0:o.id)!="number")return;const g=(i==null?void 0:i[`b${o.id}`])||(i==null?void 0:i[String(o.id)]);if(!yt(g))return;const _=!!(g!=null&&g.stacking),u=Number(((D=(p=o==null?void 0:o.buffData)==null?void 0:p[0])==null?void 0:D.uptime)??0),a=Number(((W=(q=o==null?void 0:o.buffData)==null?void 0:q[0])==null?void 0:W.presence)??0),V=_?a:u;!Number.isFinite(V)||V<=0||(N+=Math.min(Math.max(V,0),100),s+=1)}),{boonCount:s,boonUptimePct:s>0?N/s:0}},t=(n,i)=>{if(!Number.isFinite(n))return 0;const r=Math.max(1/60,Number(i||0)/6e4);return n/r},m=(n,i,r)=>{var g;let N=`Skill ${n==null?void 0:n.id}`;const s=(i==null?void 0:i[`s${n==null?void 0:n.id}`])||(i==null?void 0:i[`${n==null?void 0:n.id}`]);let o=s==null?void 0:s.icon;if(s!=null&&s.name&&(N=s.name),N.startsWith("Skill ")){const _=Et(N,n==null?void 0:n.id,r);_&&(N=_,o=((g=r==null?void 0:r[`b${n==null?void 0:n.id}`])==null?void 0:g.icon)||o)}return{name:N,icon:o}},F=n=>{if(!Array.isArray(n))return[];const i=[];return n.forEach(r=>{Array.isArray(r)&&r.forEach(N=>{!N||typeof N!="object"||i.push(N)})}),i},f=n=>Array.isArray(n)?n.map(i=>Array.isArray(i)?[Number(i[0]),Number(i[1])]:i&&typeof i=="object"?[Number(i.time),Number(i.value)]:null).filter(i=>!!i&&Number.isFinite(i[0])&&Number.isFinite(i[1])&&i[0]>=0).sort((i,r)=>i[0]-r[0]):[],j=(n,i)=>{if(!i)return 1;const r=String(n||"").trim().toLowerCase();return 25},T=(n,i,r,N)=>{const s=Array.from({length:i},()=>0);if(!n||typeof n!="object"||i<=0)return s;Object.values(n).forEach(g=>{const _=f(g);if(_.length===0)return;let u=0,a=0;for(let V=0;V<i;V+=1){const p=V*5e3;for(;u<_.length&&_[u][0]<=p;)a=Math.max(0,Number(_[u][1]||0)),u+=1;s[V]+=Math.max(0,Number(a||0))}});const o=j(N,r);return s.map(g=>r?Math.max(0,Math.min(o,Math.round(g)))/Math.max(1,o)*100:g>0?100:0)},Z=n=>!Array.isArray(n)||n.length===0?[]:typeof n[0]=="number"?n.map(i=>Number(i||0)):Array.isArray(n[0])&&typeof n[0][0]=="number"?n[0].map(i=>Number(i||0)):[],J=n=>{if(!Array.isArray(n)||n.length===0)return[];const i=[];for(let r=0;r<n.length;r+=1){const N=Number(n[r]||0),s=r>0?Number(n[r-1]||0):0;i.push(Math.max(0,N-s))}return i},ie=(n,i)=>Array.from({length:i},(r,N)=>{const s=N*5;let o=0;for(let g=0;g<5;g+=1)o+=Number(n[s+g]||0);return o}),E=(n,i,r)=>{const N=new Map;return F(n).forEach(s=>{if(!(s!=null&&s.id))return;const{name:o,icon:g}=m(s,i,r),_=`s${s.id}`,u=N.get(_)||{id:_,name:o,icon:g,damage:0,hits:0};u.damage+=Math.max(0,Number((s==null?void 0:s.totalDamage)||0)),u.hits+=Math.max(0,Number((s==null?void 0:s.hits)||(s==null?void 0:s.connectedHits)||0)),u.name.startsWith("Skill ")&&!o.startsWith("Skill ")&&(u.name=o),!u.icon&&g&&(u.icon=g),N.set(_,u)}),Array.from(N.values()).sort((s,o)=>o.damage-s.damage||o.hits-s.hits||s.name.localeCompare(o.name))},l=(n,i,r)=>{const N=new Map;return(Array.isArray(n==null?void 0:n.buffUptimes)?n.buffUptimes:[]).forEach(o=>{var O,w,x,K;const g=Number(o==null?void 0:o.id);if(!Number.isFinite(g))return;const _=`b${g}`,u=(i==null?void 0:i[_])||(i==null?void 0:i[String(g)])||{};if(!yt(u))return;const a=!!(u!=null&&u.stacking),V=Number(((w=(O=o==null?void 0:o.buffData)==null?void 0:O[0])==null?void 0:w.uptime)??0),p=Number(((K=(x=o==null?void 0:o.buffData)==null?void 0:x[0])==null?void 0:K.presence)??0),D=Math.min(100,Math.max(0,a?p:V));if(!Number.isFinite(D)||D<=0)return;const q=N.get(_)||{id:_,name:String((u==null?void 0:u.name)||_),icon:u==null?void 0:u.icon,stacking:a,uptimePct:0,uptimeMs:0,buckets5s:[]};q.uptimePct=Math.max(q.uptimePct,D),q.uptimeMs+=D/100*Math.max(0,Number(r||0));const W=o!=null&&o.statesPerSource&&typeof o.statesPerSource=="object"?o.statesPerSource:null;W&&(q.buckets5s=T(W,Math.max(1,Math.ceil(Math.max(1,Number(r||0))/5e3)),!!(u!=null&&u.stacking),String((u==null?void 0:u.name)||""))),!q.icon&&(u!=null&&u.icon)&&(q.icon=u.icon),N.set(_,q)}),Array.from(N.values()).sort((o,g)=>g.uptimePct-o.uptimePct||g.uptimeMs-o.uptimeMs||o.name.localeCompare(g.name))},d=new Map,$=15e3,k=15e3,R=n=>Array.isArray(n)?n.map(i=>Array.isArray(i)?[Number(i[0]),Number(i[1])]:null).filter(i=>!!i&&Number.isFinite(i[0])):[],H=(n,i)=>{const r=n==null?void 0:n.combatReplayData;return(Array.isArray(r)?r:r?[r]:[]).flatMap(s=>R(s==null?void 0:s[i]).map(([o])=>Number(o||0))).filter(s=>Number.isFinite(s)&&s>=0)},Q=(n,i)=>{if(!Array.isArray(n)||n.length===0)return null;const r=n.flatMap(N=>H(N,i));return r.length===0?null:Math.min(...r)},b=n=>{const i=n.filter(r=>typeof r=="number"&&Number.isFinite(r));return i.length===0?null:i.reduce((r,N)=>r+N,0)/i.length},S=n=>{const i=n.filter(N=>typeof N=="boolean");return i.length===0?null:i.reduce((N,s)=>N+(s?1:0),0)/i.length*100},C=n=>Array.isArray(n)?n.map(i=>Array.isArray(i)?[Number(i[0]),Number(i[1])]:null).filter(i=>!!i&&Number.isFinite(i[0])&&Number.isFinite(i[1])):[],I=(n,i,r)=>{const s=(Array.isArray(n)?n:n?[n]:[]).flatMap(q=>C(q==null?void 0:q.positions));if(s.length<2)return{distanceTraveled:null,movementPerMinute:null,stationaryPct:null,movementBurstCount:null};const o=Number.isFinite(r)&&r>0?r:1,g=1,_=25;let u=0,a=0,V=0,p=!1,D=0;for(let q=1;q<s.length;q+=1){const[W,O]=s[q-1],[w,x]=s[q],K=Math.hypot(w-W,x-O)/o;Number.isFinite(K)&&(D+=1,u+=Math.max(0,K),K<=g?(a+=1,p=!1):K>_&&(p||(V+=1),p=!0))}return D===0?{distanceTraveled:null,movementPerMinute:null,stationaryPct:null,movementBurstCount:null}:{distanceTraveled:u,movementPerMinute:t(u,i),stationaryPct:a/D*100,movementBurstCount:V}};return zn.forEach(({log:n},i)=>{var Ut;const r=n==null?void 0:n.details;if(!r)return;const s=(Array.isArray(r==null?void 0:r.players)?r.players:[]).filter(te=>!(te!=null&&te.notInSquad));if(s.length===0)return;const o=s.filter(te=>!!(te!=null&&te.hasCommanderTag));if(o.length===0)return;const g=[...o].sort((te,le)=>{const it=Array.isArray(te==null?void 0:te.activeTimes)?Number(te.activeTimes[0]||0):0,He=Array.isArray(le==null?void 0:le.activeTimes)?Number(le.activeTimes[0]||0):0;return He!==it?He-it:String((te==null?void 0:te.account)||(te==null?void 0:te.name)||"").localeCompare(String((le==null?void 0:le.account)||(le==null?void 0:le.name)||""))})[0];if(!g)return;const _=String((g==null?void 0:g.account)||(g==null?void 0:g.name)||`Commander ${i+1}`),u=String((g==null?void 0:g.name)||""),a=rt((g==null?void 0:g.profession)||(g==null?void 0:g.name)||"Unknown"),V=Math.max(0,Number((r==null?void 0:r.durationMS)||0)),p=r!=null&&r.combatReplayMetaData&&typeof r.combatReplayMetaData=="object"?r.combatReplayMetaData:{},D=Number((p==null?void 0:p.inchToPixel)||0)>0?Number(p.inchToPixel):1,q=ze(r,n),W=bt(r,n),O=s.length,w=Array.isArray(r==null?void 0:r.targets)?r.targets.filter(te=>!(te!=null&&te.isFake)).length:0,x=((Ut=g==null?void 0:g.defenses)==null?void 0:Ut[0])||{},K=Math.max(0,Number((x==null?void 0:x.downCount)||0)),ne=Math.max(0,Number((x==null?void 0:x.deadCount)||0)),oe=Math.max(0,Number((x==null?void 0:x.damageTaken)||0)),ue=Math.max(0,Number((x==null?void 0:x.damageBarrier)||0)),he=Math.max(0,Number((x==null?void 0:x.boonStrips)||0)),Se=Math.max(0,Number((x==null?void 0:x.receivedCrowdControl)||0)),Ie=n!=null&&n.dashboardSummary&&typeof n.dashboardSummary=="object"?n.dashboardSummary:null,Ce=Array.isArray(r==null?void 0:r.targets)?r.targets.filter(te=>!(te!=null&&te.isFake)):[],X=Array.isArray(r==null?void 0:r.targets)?r.targets.some(te=>!(te!=null&&te.isFake)):!1,{enemyDeaths:fe,enemyDownsDeaths:Le}=we(r),Ve=X||s.length>0?fe:Math.max(0,Number((Ie==null?void 0:Ie.enemyDeaths)||0)),Ue=X||s.length>0?Math.max(0,Le-fe):Math.max(0,Number((Ie==null?void 0:Ie.enemyDowns)||0)),$e=Q(Ce,"down"),ut=Q(Ce,"dead"),st=Q([g],"dead"),vt=s.flatMap(te=>H(te,"dead")),Dt=Ce.flatMap(te=>H(te,"dead")),mt=st!==null?vt.filter(te=>te>st).length:null,lt=st!==null&&Dt.length>0?Dt.filter(te=>te>st).length:null,xt=$e!==null&&ut!==null&&ut>=$e?ut-$e:null,Nt=Ue>0?Ve/Ue*100:null,St=Math.max(0,Ue-Ve),Ft=$e!==null?$e<=$:null,U=$e!==null?ut===null||ut-$e>k:null,L=st!==null&&mt!==null&&lt!==null?mt>lt:null,A=st!==null&&mt!==null&&lt!==null?lt>0&&lt>=mt:null,B=s.reduce((te,le)=>{var it,He;return te+Math.max(0,Number(((He=(it=le==null?void 0:le.defenses)==null?void 0:it[0])==null?void 0:He.downCount)||0))},0),G=s.reduce((te,le)=>{var it,He;return te+Math.max(0,Number(((He=(it=le==null?void 0:le.defenses)==null?void 0:it[0])==null?void 0:He.deadCount)||0))},0),ae=r!=null&&r.buffMap&&typeof(r==null?void 0:r.buffMap)=="object"?r.buffMap:{},be=r!=null&&r.skillMap&&typeof(r==null?void 0:r.skillMap)=="object"?r.skillMap:{},{boonCount:Pe,boonUptimePct:qe}=e(g,ae),dt=E(g==null?void 0:g.totalDamageTaken,be,ae),Ge=l(g,ae,V),Ze=I(g==null?void 0:g.combatReplayData,V,D),kt=Math.max(1,Math.ceil(Math.max(1,V)/5e3)),ot=Z(g==null?void 0:g.powerDamageTaken1S),Gt=J(ot),Lt=ie(Gt,kt),ft=(()=>{const te=Ge.map(le=>Array.isArray(le==null?void 0:le.buckets5s)?le.buckets5s:[]).filter(le=>le.length>0);return te.length===0?Array.from({length:kt},()=>qe):Array.from({length:kt},(le,it)=>te.reduce((Mt,Ct)=>Mt+Number(Ct[it]||0),0)/te.length)})(),pt=Te(r),At=_;d.has(At)||d.set(At,{key:At,account:_,characterNames:new Set,primaryProfession:a,professionTimeMs:{},fights:0,wins:0,losses:0,totalDurationMs:0,totalSquadCount:0,totalEnemyCount:0,totalKills:0,totalDowns:0,totalCommanderDowns:0,totalCommanderDeaths:0,totalAlliesDown:0,totalAlliesDead:0,totalDamageTaken:0,totalIncomingBarrierAbsorbed:0,totalIncomingStrips:0,totalIncomingCC:0,boonWeightedPctMs:0,boonDurationMs:0,boonEntriesSeen:0,incomingSkillMap:new Map,incomingBoonMap:new Map,fightRows:[]});const Ee=d.get(At);u&&Ee.characterNames.add(u);const Yt=Array.isArray(g==null?void 0:g.activeTimes)&&typeof g.activeTimes[0]=="number"?Math.max(0,Number(g.activeTimes[0]||0)):V;Ee.professionTimeMs[a]=(Ee.professionTimeMs[a]||0)+Yt,Ee.fights+=1,Ee.wins+=pt?1:0,Ee.losses+=pt?0:1,Ee.totalDurationMs+=V,Ee.totalSquadCount+=O,Ee.totalEnemyCount+=w,Ee.totalKills+=Ve,Ee.totalDowns+=Ue,Ee.totalCommanderDowns+=K,Ee.totalCommanderDeaths+=ne,Ee.totalAlliesDown+=B,Ee.totalAlliesDead+=G,Ee.totalDamageTaken+=oe,Ee.totalIncomingBarrierAbsorbed+=ue,Ee.totalIncomingStrips+=he,Ee.totalIncomingCC+=Se,Ee.boonWeightedPctMs+=qe*V,Ee.boonDurationMs+=V,Ee.boonEntriesSeen+=Pe,dt.forEach(te=>{const le=Ee.incomingSkillMap.get(te.id)||{...te,damage:0,hits:0};le.damage+=Number(te.damage||0),le.hits+=Number(te.hits||0),le.name.startsWith("Skill ")&&!te.name.startsWith("Skill ")&&(le.name=te.name),!le.icon&&te.icon&&(le.icon=te.icon),Ee.incomingSkillMap.set(te.id,le)}),Ge.forEach(te=>{const le=Ee.incomingBoonMap.get(te.id)||{id:te.id,name:te.name,icon:te.icon,stacking:te.stacking,uptimePctWeightedMs:0,durationMs:0};le.uptimePctWeightedMs+=Number(te.uptimePct||0)*V,le.durationMs+=V,!le.icon&&te.icon&&(le.icon=te.icon),Ee.incomingBoonMap.set(te.id,le)}),Ee.fightRows.push({id:String((n==null?void 0:n.filePath)||(n==null?void 0:n.id)||`fight-${i+1}`),shortLabel:`F${i+1}`,fullLabel:`${W||(n==null?void 0:n.encounterName)||"Unknown Map"} • ${Tt(V)}`,timestamp:q,mapName:W,durationMs:V,duration:Tt(V),isWin:pt,squadCount:O,enemyCount:w,kills:Ve,downs:Ue,commanderDowns:K,commanderDeaths:ne,alliesDown:B,alliesDead:G,damageTaken:oe,damageTakenPerMinute:t(oe,V),incomingBarrierAbsorbed:ue,incomingBarrierAbsorbedPerMinute:t(ue,V),incomingStrips:he,incomingStripsPerMinute:t(he,V),incomingCC:Se,incomingCCPerMinute:t(Se,V),timeToFirstEnemyDownMs:$e,timeToFirstEnemyDeathMs:ut,downToKillConversionMs:xt,hadEarlyDown:Ft,wasStalledPush:U,downToKillConversionPct:Nt,failedDownEstimate:St,distanceTraveled:Ze.distanceTraveled,movementPerMinute:Ze.movementPerMinute,stationaryPct:Ze.stationaryPct,movementBurstCount:Ze.movementBurstCount,commanderDiedAtMs:st,squadDeathsAfterTagDeath:mt,enemyKillsAfterTagDeath:lt,collapsedAfterTagDeath:L,recoveredAfterTagDeath:A,boonUptimePct:qe,boonEntries:Pe,incomingDamageBySkill:dt,incomingBoonUptimes:Ge,incomingDamageBuckets5s:Lt,incomingBoonBuckets5s:ft})}),{rows:Array.from(d.values()).map(n=>{const i=Object.keys(n.professionTimeMs).filter(X=>X&&X!=="Unknown").sort((X,fe)=>(n.professionTimeMs[fe]||0)-(n.professionTimeMs[X]||0)),r=i[0]||n.primaryProfession||"Unknown",N=n.boonDurationMs>0?n.boonWeightedPctMs/n.boonDurationMs:0,s=n.totalCommanderDeaths>0?n.totalKills/n.totalCommanderDeaths:n.totalKills,o=Math.max(1/60,n.totalDurationMs/6e4),g=[...n.fightRows].sort((X,fe)=>X.timestamp>0&&fe.timestamp>0&&X.timestamp!==fe.timestamp?X.timestamp-fe.timestamp:X.shortLabel.localeCompare(fe.shortLabel,void 0,{numeric:!0})),_=b(g.map(X=>X.timeToFirstEnemyDownMs)),u=b(g.map(X=>X.timeToFirstEnemyDeathMs)),a=b(g.map(X=>X.downToKillConversionMs)),V=S(g.map(X=>X.hadEarlyDown)),p=S(g.map(X=>X.wasStalledPush)),D=n.totalDowns>0?n.totalKills/n.totalDowns*100:null,q=n.fights>0?n.totalKills/n.fights:null,W=n.fights>0?n.totalDowns/n.fights:null,O=Math.max(0,n.totalDowns-n.totalKills),w=b(g.map(X=>X.distanceTraveled)),x=b(g.map(X=>X.movementPerMinute)),K=b(g.map(X=>X.stationaryPct)),ne=b(g.map(X=>X.movementBurstCount)),oe=g.filter(X=>X.commanderDiedAtMs!==null).length,ue=g.filter(X=>X.commanderDiedAtMs!==null),he=b(ue.map(X=>X.squadDeathsAfterTagDeath)),Se=b(ue.map(X=>X.enemyKillsAfterTagDeath)),Ie=S(ue.map(X=>X.collapsedAfterTagDeath)),Ce=S(ue.map(X=>X.recoveredAfterTagDeath));return{key:n.key,account:n.account,characterNames:Array.from(n.characterNames.values()).sort((X,fe)=>X.localeCompare(fe)),profession:r,professionList:i,fights:n.fights,wins:n.wins,losses:n.losses,winRatePct:n.fights>0?n.wins/n.fights*100:0,totalDurationMs:n.totalDurationMs,avgSquadSize:n.fights>0?n.totalSquadCount/n.fights:0,avgEnemySize:n.fights>0?n.totalEnemyCount/n.fights:0,kills:n.totalKills,downs:n.totalDowns,commanderDowns:n.totalCommanderDowns,commanderDeaths:n.totalCommanderDeaths,alliesDown:n.totalAlliesDown,alliesDead:n.totalAlliesDead,kdr:s,damageTaken:n.totalDamageTaken,damageTakenPerMinute:n.totalDamageTaken/o,incomingBarrierAbsorbed:n.totalIncomingBarrierAbsorbed,incomingBarrierAbsorbedPerMinute:n.totalIncomingBarrierAbsorbed/o,incomingStrips:n.totalIncomingStrips,incomingStripsPerMinute:n.totalIncomingStrips/o,incomingCC:n.totalIncomingCC,incomingCCPerMinute:n.totalIncomingCC/o,avgTimeToFirstEnemyDownMs:_,avgTimeToFirstEnemyDeathMs:u,avgDownToKillConversionMs:a,pushesWithEarlyDownPct:V,stalledPushPct:p,downToKillConversionPct:D,avgKillsPerFight:q,avgDownsPerFight:W,failedDownEstimate:O,avgCommanderDistanceTraveled:w,avgCommanderMovementPerMinute:x,avgTagStationaryPct:K,avgTagMovementBurstCount:ne,fightsWithCommanderDeath:oe,avgSquadDeathsAfterTagDeath:he,avgEnemyKillsAfterTagDeath:Se,squadCollapseAfterTagDeathPct:Ie,recoveryAfterTagDeathPct:Ce,boonUptimePct:N,boonEntries:n.boonEntriesSeen,incomingSkillBreakdown:Array.from(n.incomingSkillMap.values()).sort((X,fe)=>fe.damage-X.damage||fe.hits-X.hits||X.name.localeCompare(fe.name)),incomingBoonBreakdown:Array.from(n.incomingBoonMap.values()).map(X=>({id:X.id,name:X.name,icon:X.icon,stacking:X.stacking,uptimePct:X.durationMs>0?X.uptimePctWeightedMs/X.durationMs:0})).sort((X,fe)=>fe.uptimePct-X.uptimePct||X.name.localeCompare(fe.name)),fightsData:g}}).sort((n,i)=>{const r=Number(i.totalDurationMs||0)-Number(n.totalDurationMs||0);if(r!==0)return r;const N=Number(i.wins||0)-Number(n.wins||0);return N!==0?N:String(n.account||"").localeCompare(String(i.account||""))})}})(),Zs=zn.map(({log:e},t)=>{const m=e.details;if(!m)return null;const f=(Array.isArray(m.players)?m.players:[]).filter(p=>!p.notInSquad),j=Array.isArray(m.targets)?m.targets:[],T=ze(m,e),Z=bt(m,e),J=Number(m.durationMS||0),{squadDownsDeaths:ie,enemyDownsDeaths:E,squadDeaths:l,enemyDeaths:d}=we(m),$=new Map,k=(p,D,q)=>{const W=$.get(p)||{label:p,damage:0,hits:0};W.damage+=D,W.hits+=q,$.set(p,W)};if(f.forEach(p=>{(Array.isArray(p==null?void 0:p.statsTargets)?p.statsTargets:[]).forEach((q,W)=>{const O=Array.isArray(q)?q[0]:q,w=Number((O==null?void 0:O.damage)??(O==null?void 0:O.totalDmg)??(O==null?void 0:O.connectedDmg)??0),x=Number((O==null?void 0:O.connectedHits)??(O==null?void 0:O.connectedDamageCount)??(O==null?void 0:O.hits)??0);if(w<=0&&x<=0)return;const K=j[W];if(K!=null&&K.isFake)return;const ne=(K==null?void 0:K.profession)||(K==null?void 0:K.name)||(K==null?void 0:K.id)||`Target ${W+1}`,oe=rt(ne);k(oe||String(ne),w,x)})}),$.size===0){const p=new Map,D=q=>{if(!Array.isArray(q)||q.length===0)return[];const W=q[0];if(Array.isArray(W)&&Array.isArray(W[0])){if(typeof W[0][0]=="number")return W;if(Array.isArray(W[0])&&typeof W[0][0]=="number")return q.map(O=>Array.isArray(O)?O[0]||[]:[])}return[]};f.forEach(q=>{D(q==null?void 0:q.targetDamage1S).forEach((O,w)=>{if(!Array.isArray(O)||O.length===0)return;const x=O.map(ne=>Number(ne)).filter(ne=>Number.isFinite(ne)&&ne>=0);if(x.length===0)return;const K=Math.max(0,x[x.length-1]||0);K<=0||p.set(w,(p.get(w)||0)+K)})}),p.forEach((q,W)=>{if(q<=0)return;const O=j[W];if(O!=null&&O.isFake)return;const w=(O==null?void 0:O.profession)||(O==null?void 0:O.name)||(O==null?void 0:O.id)||`Target ${W+1}`,x=rt(w);k(x||String(w),q,0)})}if($.size===0&&j.forEach((p,D)=>{if(p!=null&&p.isFake)return;const q=Array.isArray(p==null?void 0:p.totalDamageTaken)?p.totalDamageTaken:Array.isArray(p==null?void 0:p.totalDamageDist)?p.totalDamageDist:[];let W=0,O=0;if(q.forEach(K=>{W+=Number((K==null?void 0:K.totalDamage)||(K==null?void 0:K.damage)||0),O+=Number((K==null?void 0:K.connectedHits)||(K==null?void 0:K.hits)||0)}),W<=0&&Number((p==null?void 0:p.damageTaken)||0)>0&&(W=Number(p.damageTaken||0)),W<=0&&O<=0)return;const w=(p==null?void 0:p.profession)||(p==null?void 0:p.name)||(p==null?void 0:p.id)||`Target ${D+1}`,x=rt(w);k(x||String(w),W,O)}),$.size===0){const p=new Map;j.forEach((D,q)=>{if(D!=null&&D.isFake)return;const W=(D==null?void 0:D.profession)||(D==null?void 0:D.name)||(D==null?void 0:D.id)||`Target ${q+1}`,O=rt(W)||String(W);p.set(O,(p.get(O)||0)+1)}),p.forEach((D,q)=>{D>0&&k(q,D,0)})}const R=Array.from($.values()).sort((p,D)=>D.damage-p.damage||D.hits-p.hits||p.label.localeCompare(D.label)),H=R.reduce((p,D)=>p+D.damage,0),Q=R.map(p=>({label:p.label,damage:p.damage,hits:p.hits,share:H>0?p.damage/H:0})),b=j.filter(p=>!(p!=null&&p.isFake)).length,S=f.length,C=f.reduce((p,D)=>{var q,W;return p+Number(((W=(q=D==null?void 0:D.dpsAll)==null?void 0:q[0])==null?void 0:W.damage)||0)},0),I=f.reduce((p,D)=>{var q,W;return p+Number(((W=(q=D==null?void 0:D.defenses)==null?void 0:q[0])==null?void 0:W.damageTaken)||0)},0),P=f.reduce((p,D)=>{var q,W;return p+Number(((W=(q=D==null?void 0:D.defenses)==null?void 0:q[0])==null?void 0:W.damageBarrier)||0)},0),n=f.reduce((p,D)=>{var O;const q=(O=D==null?void 0:D.extBarrierStats)==null?void 0:O.outgoingBarrier;if(!Array.isArray(q))return p;let W=0;return q.forEach(w=>{Array.isArray(w)?w.forEach(x=>{W+=Number((x==null?void 0:x.barrier)||0)}):W+=Number((w==null?void 0:w.barrier)||0)}),p+W},0),i=f.reduce((p,D)=>{var q,W;return Number(((W=(q=D==null?void 0:D.statsAll)==null?void 0:q[0])==null?void 0:W.saved)||0)>0?p+1:p},0),r=f.reduce((p,D)=>p+Number(fn(D)||0),0),N=f.reduce((p,D)=>p+Number(gn(D)||0),0),s=f.reduce((p,D)=>p+Number((D==null?void 0:D.stabGeneration)||0),0),o=f.reduce((p,D)=>p+Number(pn(D)||0),0),g=f.reduce((p,D)=>p+Number(bn(D)||0),0),_=f.reduce((p,D)=>p+Number(Dn(D)||0),0),u=f.reduce((p,D)=>p+Number(hn(D)||0),0),a=l>0?d/l:d,V=[{metricId:"winFlag",metricLabel:"Win (1) / Loss (0)",higherIsBetter:!0,value:Te(m)?1:0},{metricId:"squadCount",metricLabel:"Squad Size",higherIsBetter:!0,value:S},{metricId:"enemyCount",metricLabel:"Enemy Count",higherIsBetter:!1,value:b},{metricId:"squadKdr",metricLabel:"Squad KDR",higherIsBetter:!0,value:a},{metricId:"enemyDeaths",metricLabel:"Enemy Deaths",higherIsBetter:!0,value:d},{metricId:"enemyDowns",metricLabel:"Enemy Downs",higherIsBetter:!0,value:Math.max(0,E-d)},{metricId:"squadDeaths",metricLabel:"Squad Deaths",higherIsBetter:!1,value:l},{metricId:"squadDowns",metricLabel:"Squad Downs",higherIsBetter:!1,value:Math.max(0,ie-l)},{metricId:"damageDelta",metricLabel:"Damage Delta",higherIsBetter:!0,value:C-I},{metricId:"outgoingDamage",metricLabel:"Outgoing Damage",higherIsBetter:!0,value:C},{metricId:"incomingDamage",metricLabel:"Incoming Damage",higherIsBetter:!1,value:I},{metricId:"cleanses",metricLabel:"Squad Cleanses",higherIsBetter:!0,value:r},{metricId:"strips",metricLabel:"Squad Strips",higherIsBetter:!0,value:N},{metricId:"stability",metricLabel:"Squad Stability",higherIsBetter:!0,value:s},{metricId:"healing",metricLabel:"Squad Healing",higherIsBetter:!0,value:o},{metricId:"barrierOut",metricLabel:"Squad Barrier Out",higherIsBetter:!0,value:g},{metricId:"barrierIncomingAbsorb",metricLabel:"Barrier Absorption (Incoming)",higherIsBetter:!0,value:P},{metricId:"enemyBarrierAbsorb",metricLabel:"Enemy Barrier Absorption",higherIsBetter:!1,value:n},{metricId:"cc",metricLabel:"Squad CC",higherIsBetter:!0,value:_},{metricId:"downContrib",metricLabel:"Squad Down Contribution",higherIsBetter:!0,value:u},{metricId:"alliesRevived",metricLabel:"Allies Revived (Players)",higherIsBetter:!0,value:i}];return{id:e.filePath||e.id||`fight-${t+1}`,shortLabel:`F${t+1}`,fullLabel:`${Z||e.encounterName||"Unknown Map"} • ${Tt(J)}`,mapName:Z,timestamp:T,duration:Tt(J),isWin:Te(m),targetFocus:Q,squadMetrics:V}}).filter(Boolean),ys=Array.from(pe.values()).map(e=>{const t=Object.entries(e.professionTimeMs||{}).map(([m,F])=>({profession:m,timeMs:Number(F||0)})).filter(m=>m.profession&&m.profession!=="Unknown"&&m.timeMs>0).sort((m,F)=>{const f=F.timeMs-m.timeMs;return f!==0?f:m.profession.localeCompare(F.profession)});return{account:e.account||"Unknown",characterNames:Array.from(e.characterNames||[]).filter(Boolean).sort((m,F)=>m.localeCompare(F)),classTimes:t,combatTimeMs:Number(e.squadActiveMs||e.totalFightMs||0),squadTimeMs:(()=>{const m=Number(e.firstSeenFightTs||0),F=Number(e.lastSeenFightTs||0),f=Math.max(0,Number(e.lastSeenFightDurationMs||0));return m>0&&F>0?Math.max(0,F+f-m):Number(e.squadActiveMs||e.totalFightMs||0)})()}}).filter(e=>e.account&&e.account!=="Unknown").sort((e,t)=>{const m=t.squadTimeMs-e.squadTimeMs;return m!==0?m:String(e.account).localeCompare(String(t.account))}),ei=se.map(e=>e).sort((e,t)=>ze(e.details,e)-ze(t.details,t)).map((e,t)=>{const m=e==null?void 0:e.details,F=Array.isArray(m==null?void 0:m.players)?m.players.filter(T=>!(T!=null&&T.notInSquad)):[],f=new Map;F.forEach(T=>{const Z=Number(T==null?void 0:T.group),J=Number.isFinite(Z)&&Z>0?Z:0;f.has(J)||f.set(J,{party:J,players:[],classCounts:{}});const ie=rt((T==null?void 0:T.profession)||(T==null?void 0:T.name)||"Unknown"),E=String((T==null?void 0:T.account)||"Unknown"),l=String((T==null?void 0:T.name)||(T==null?void 0:T.character_name)||""),d=!!(T!=null&&T.hasCommanderTag),$=f.get(J);$.players.push({account:E,characterName:l,profession:ie,isCommander:d}),$.classCounts[ie]=($.classCounts[ie]||0)+1});const j=Array.from(f.values()).map(T=>({...T,players:T.players.sort((Z,J)=>{const ie=+!!J.isCommander-+!!Z.isCommander;if(ie!==0)return ie;const E=String(Z.profession).localeCompare(String(J.profession));return E!==0?E:String(Z.account).localeCompare(String(J.account))})})).sort((T,Z)=>T.party===0&&Z.party!==0?1:Z.party===0&&T.party!==0?-1:T.party-Z.party);return{id:String((e==null?void 0:e.filePath)||(e==null?void 0:e.id)||`fight-${t+1}`),label:`F${t+1}`,timestamp:ze(m,e),mapName:bt(m,e),duration:Tt(Number((m==null?void 0:m.durationMS)||0)),parties:j}}),ti=(e,t)=>{const m=(t==null?void 0:t.skillMap)||{},F=(t==null?void 0:t.buffMap)||{};let f=0,j=0,T="";const Z=E=>{const l=Number(E);if(!Number.isFinite(l))return String(E||"Unknown Skill");const d=(m==null?void 0:m[`s${l}`])||(m==null?void 0:m[`${l}`]);if(d!=null&&d.name)return String(d.name);const $=(F==null?void 0:F[`b${l}`])||(F==null?void 0:F[`${l}`]);return $!=null&&$.name?String($.name):`Skill ${l}`},J=E=>{if(!E||typeof E!="object")return;const l=[Number(E.max),Number(E.maxDamage),Number(E.maxHit)].filter(k=>Number.isFinite(k)),d=l.length>0?Math.max(...l):0;d>f&&(f=d,T=Z(E.id));const $=Number(E.downContribution||0);$>j&&(j=$)};let ie=!1;return Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(l=>{Array.isArray(l)&&l.forEach(d=>{ie=!0,J(d)})})}),(!ie||f<=0)&&Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(E=>{Array.isArray(E)&&E.forEach(l=>J(l))}),{peak:f,peakDownContribution:j,skillName:T||"Unknown Skill"}},ni=(()=>{const e=k=>String(k||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=k=>e(k).toLowerCase().split(/[^a-z0-9]+/i).map(R=>R.trim()).filter(Boolean).map(R=>R.length>3&&R.endsWith("s")?R.slice(0,-1):R),m=(k,R)=>{const H=e(k),Q=e(R);if(!Q)return H;if(!H)return Q;const b=t(H),S=t(Q),C=new Set(b),I=new Set(S),P=S.length>0&&S.every(i=>C.has(i)),n=b.length>0&&b.every(i=>I.has(i));return P||n?H:`${H} - ${Q}`},F=[],f=new Map,j=k=>{const R=P=>{if(!Array.isArray(P)||P.length===0)return[];const n=[];for(let i=0;i<P.length;i+=1){const r=Number(P[i]||0),N=i>0?Number(P[i-1]||0):0;n.push(Math.max(0,r-N))}return n},H=P=>{if(!Array.isArray(P))return[];const n=P.reduce((r,N)=>Math.max(r,Array.isArray(N)?N.length:0),0);if(n<=0)return[];const i=new Array(n).fill(0);return P.forEach(r=>{if(Array.isArray(r))for(let N=0;N<n;N+=1)i[N]+=Number(r[N]||0)}),i},Q=P=>Array.isArray(P)?P.map(n=>Number(n||0)):null,S=(P=>{if(!Array.isArray(P)||P.length===0)return null;const n=P[0];if(!Array.isArray(n))return null;if(Array.isArray(n[0])&&Array.isArray(n[0][0]))return H(n);if(Array.isArray(n[0])&&!Array.isArray(n[0][0])){const i=P.map(r=>Q(Array.isArray(r)?r[0]:null)).filter(r=>Array.isArray(r)&&r.length>0);if(i.length>0)return H(i)}return null})(k==null?void 0:k.targetDamage1S),C=Array.isArray(k==null?void 0:k.damage1S)&&Array.isArray(k.damage1S[0])?k.damage1S[0]:null,I=S||(Array.isArray(C)?C.map(P=>Number(P||0)):[]);return R(I)},T=(k,R)=>{if(!Array.isArray(k)||k.length===0||R<=0)return 0;let H=0,Q=0;for(let b=0;b<k.length;b+=1)H+=Number(k[b]||0),b>=R&&(H-=Number(k[b-R]||0)),b>=R-1&&H>Q&&(Q=H);return Math.max(0,Q)},Z=(k,R)=>{if(!Array.isArray(k)||k.length===0||R<=0)return[];const H=[];for(let Q=0;Q<k.length;Q+=R){const b=Math.min(Q+R,k.length),S=k.slice(Q,b).reduce((C,I)=>C+Number(I||0),0);H.push(S)}return H},J=(k,R)=>{let H=0,Q=0;const b=new Map,S=I=>{if(!I||typeof I!="object"||I.indirectDamage)return;const P=Number(I.totalDamage||0),n=Number(I.downContribution||0);!Number.isFinite(P)&&!Number.isFinite(n)||(H+=Number.isFinite(P)?P:0,Q+=Number.isFinite(n)?n:0)};return Array.isArray(k==null?void 0:k.targetDamageDist)&&k.targetDamageDist.forEach(I=>{Array.isArray(I)&&I.forEach(P=>{Array.isArray(P)&&P.forEach(n=>{const i=Number(n==null?void 0:n.id);if(Number.isFinite(i)){const r=b.get(i)||{damage:0,downContribution:0};r.damage+=Number((n==null?void 0:n.totalDamage)||0),r.downContribution+=Number((n==null?void 0:n.downContribution)||0),b.set(i,r)}S(n)})})}),!(R!=null&&R.detailedWvW)&&Array.isArray(k==null?void 0:k.totalDamageDist)&&k.totalDamageDist.forEach(I=>{Array.isArray(I)&&I.forEach(P=>{const n=Number(P==null?void 0:P.id);if(!Number.isFinite(n)){S(P);return}const i=b.get(n);if(!i){S(P);return}const r=Number((P==null?void 0:P.totalDamage)||0)-Number(i.damage||0),N=Number((P==null?void 0:P.downContribution)||0)-Number(i.downContribution||0);r<=0&&N<=0||S({...P,totalDamage:Math.max(0,r),downContribution:Math.max(0,N)})})}),{damageTotal:Math.max(0,H),downContributionTotal:Math.max(0,Q)}},ie=(k,R)=>{const H=Number(k);if(!Number.isFinite(H))return{name:String(k||"Unknown Skill"),icon:void 0};const Q=(R==null?void 0:R.skillMap)||{},b=(R==null?void 0:R.buffMap)||{},S=(Q==null?void 0:Q[`s${H}`])||(Q==null?void 0:Q[`${H}`]);if(S!=null&&S.name)return{name:String(S.name),icon:S==null?void 0:S.icon};const C=(b==null?void 0:b[`b${H}`])||(b==null?void 0:b[`${H}`]);return C!=null&&C.name?{name:String(C.name),icon:C==null?void 0:C.icon}:{name:`Skill ${H}`,icon:void 0}},E=k=>Array.isArray(k)?k.map(R=>Array.isArray(R)?[Number(R[0]),Number(R[1])]:R&&typeof R=="object"?[Number(R.time),Number(R.value)]:null).filter(R=>!!R&&Number.isFinite(R[0])&&R[0]>=0):[],l=(k,R,H,Q,b)=>{if(!k.length||Q<=0)return[];const S=Math.max(Q*5e3,b||0),C=o=>o.reduce((g,_)=>_>=0&&_<=S+2e3?g+1:g,0),I=k.map(o=>Number(o||0)).filter(o=>Number.isFinite(o)&&o>=0);if(!I.length)return[];const P=[I],n=I.reduce((o,g)=>Math.max(o,g),0),i=I.reduce((o,g)=>Math.min(o,g),Number.POSITIVE_INFINITY);n>S*20&&P.push(I.map(o=>o/1e3)),n<=S*2&&i>=0&&n>0&&n<Math.max(120,Q*5+10)&&P.push(I.map(o=>o*1e3));let r=I,N=0,s=-1;return P.forEach(o=>{const g=o.reduce((u,a)=>Math.min(u,a),Number.POSITIVE_INFINITY),_=new Set([0,...R,...H]);if(Number.isFinite(g)&&S>0&&g>S){const u=Math.floor(g/S)*S;_.add(u),_.add(Math.max(0,u-S))}_.forEach(u=>{const a=o.map(p=>p-u),V=C(a);V>s&&(s=V,N=u,r=o)})}),r.map(o=>o-N).filter(o=>Number.isFinite(o)&&o>=0)},d=(k,R,H,Q,b)=>{const S=l(k,R,H,Q,b);return Array.from(new Set(S.map(C=>Math.floor(C/5e3)).filter(C=>Number.isFinite(C)&&C>=0&&C<Q)))};se.map(k=>({log:k,ts:ze(k==null?void 0:k.details,k)})).sort((k,R)=>k.ts-R.ts).forEach(({log:k},R)=>{const H=k==null?void 0:k.details;if(!H)return;const Q=e(H.fightName||k.fightName||`Fight ${R+1}`),b=bt(H,k),S=m(Q,String(b||"")),C={},I=Array.isArray(H.players)?H.players:[],P=I.flatMap(u=>{const a=u==null?void 0:u.combatReplayData;return Array.isArray(a)?a.map(V=>Number(V==null?void 0:V.start)):[Number(a==null?void 0:a.start)]}).filter(u=>Number.isFinite(u)&&u>=0);I.forEach(u=>{if(u!=null&&u.notInSquad)return;const a=String((u==null?void 0:u.account)||(u==null?void 0:u.name)||"Unknown"),V=String((u==null?void 0:u.character_name)||(u==null?void 0:u.display_name)||(u==null?void 0:u.name)||""),p=String((u==null?void 0:u.profession)||"Unknown"),D=`${a}|${p}`,q=ti(u,H),W=Number(q.peak||0),O=Number(q.peakDownContribution||0),w=j(u),{damageTotal:x,downContributionTotal:K}=J(u,H),ne=x>0?Math.min(1,Math.max(0,K/x)):0,oe=w.map(A=>Number(A||0)*ne),ue=Number(T(w,1)||0),he=Number(T(w,5)||0),Se=Number(T(w,30)||0),Ie=Number(T(oe,1)||0),Ce=Number(T(oe,5)||0),X=Number(T(oe,30)||0),fe=Math.max(0,Math.ceil(Number((H==null?void 0:H.durationMS)||0)/5e3)),Le=Math.max(0,Math.ceil(w.length/5)),Ve=Math.max(0,Math.ceil(oe.length/5)),Ue=Math.max(fe,Le,Ve),$e=Z(w,5),ut=Z(oe,5),st=Array.from({length:Ue},(A,B)=>Number($e[B]||0)),vt=Array.from({length:Ue},(A,B)=>Number(ut[B]||0)),Dt=new Map,mt=A=>{if(!A||typeof A!="object"||A.indirectDamage)return;const B=Number(A.totalDamage||0),G=Number(A.downContribution||0);if((!Number.isFinite(B)||B<=0)&&(!Number.isFinite(G)||G<=0))return;const ae=Number(A.connectedHits||A.hits||0),be=ie(A.id,H),Pe=be.name,qe=Dt.get(Pe)||{skillName:Pe,damage:0,downContribution:0,hits:0,icon:be.icon};qe.damage+=Number.isFinite(B)?B:0,qe.downContribution+=Number.isFinite(G)?G:0,qe.hits+=Number.isFinite(ae)?ae:0,!qe.icon&&be.icon&&(qe.icon=be.icon),Dt.set(Pe,qe)},lt=new Map;Array.isArray(u==null?void 0:u.targetDamageDist)&&u.targetDamageDist.forEach(A=>{Array.isArray(A)&&A.forEach(B=>{Array.isArray(B)&&B.forEach(G=>{const ae=Number(G==null?void 0:G.id),be=Number((G==null?void 0:G.totalDamage)||0),Pe=Number((G==null?void 0:G.downContribution)||0);if(Number.isFinite(ae)){const qe=lt.get(ae)||{damage:0,downContribution:0,hits:0};qe.damage+=Number.isFinite(be)?be:0,qe.downContribution+=Number.isFinite(Pe)?Pe:0,qe.hits+=Number((G==null?void 0:G.connectedHits)||(G==null?void 0:G.hits)||0),lt.set(ae,qe)}mt(G)})})}),!(H!=null&&H.detailedWvW)&&Array.isArray(u==null?void 0:u.totalDamageDist)&&u.totalDamageDist.forEach(A=>{Array.isArray(A)&&A.forEach(B=>{const G=Number(B==null?void 0:B.id);if(!Number.isFinite(G)){mt(B);return}const ae=lt.get(G);if(!ae){mt(B);return}const be=Number((B==null?void 0:B.totalDamage)||0),Pe=Number((B==null?void 0:B.downContribution)||0),qe=Number((B==null?void 0:B.connectedHits)||(B==null?void 0:B.hits)||0),dt=be-Number(ae.damage||0),Ge=Pe-Number(ae.downContribution||0),Ze=qe-Number(ae.hits||0);dt<=0&&Ge<=0&&Ze<=0||mt({...B,totalDamage:Math.max(0,dt),downContribution:Math.max(0,Ge),connectedHits:Math.max(0,Ze),hits:Math.max(0,Ze)})})});const Nt=(()=>{const A=u==null?void 0:u.combatReplayData;return Array.isArray(A)?A.filter(B=>B&&typeof B=="object"):A&&typeof A=="object"?[A]:[]})(),St=Nt.map(A=>Number(A==null?void 0:A.start)).filter(A=>Number.isFinite(A)&&A>=0),Ft=Nt.flatMap(A=>E(A==null?void 0:A.down).map(([B])=>Number(B||0))),U=Nt.flatMap(A=>E(A==null?void 0:A.dead).map(([B])=>Number(B||0)));C[D]={hit:W,burst1s:ue,burst5s:he,burst30s:Se,hitDown:O,burst1sDown:Ie,burst5sDown:Ce,burst30sDown:X,skillName:q.skillName,buckets5s:st,buckets5sDown:vt,downIndices5s:d(Ft,St,P,Ue,Number((H==null?void 0:H.durationMS)||0)),deathIndices5s:d(U,St,P,Ue,Number((H==null?void 0:H.durationMS)||0)),skillRows:Array.from(Dt.values()).sort((A,B)=>B.damage-A.damage).slice(0,50)};const L=f.get(D)||{key:D,account:a,displayName:a,characterName:V,profession:p,professionList:[p],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakHitDown:0,peak1sDown:0,peak5sDown:0,peak30sDown:0,peakFightLabel:"",peakSkillName:""};L.logs+=1,L.professionList.includes(p)||L.professionList.push(p),!L.characterName&&V&&(L.characterName=V),W>L.peakHit&&(L.peakHit=W,L.peakFightLabel=S,L.peakSkillName=q.skillName),ue>L.peak1s&&(L.peak1s=ue),he>L.peak5s&&(L.peak5s=he),Se>L.peak30s&&(L.peak30s=Se),O>L.peakHitDown&&(L.peakHitDown=O),Ie>L.peak1sDown&&(L.peak1sDown=Ie),Ce>L.peak5sDown&&(L.peak5sDown=Ce),X>L.peak30sDown&&(L.peak30sDown=X),f.set(D,L)});const n=Object.values(C).reduce((u,a)=>Math.max(u,Number((a==null?void 0:a.hit)||0)),0),i=Object.values(C).reduce((u,a)=>Math.max(u,Number((a==null?void 0:a.burst1s)||0)),0),r=Object.values(C).reduce((u,a)=>Math.max(u,Number((a==null?void 0:a.burst5s)||0)),0),N=Object.values(C).reduce((u,a)=>Math.max(u,Number((a==null?void 0:a.burst30s)||0)),0),s=Object.values(C).reduce((u,a)=>Math.max(u,Number((a==null?void 0:a.hitDown)||0)),0),o=Object.values(C).reduce((u,a)=>Math.max(u,Number((a==null?void 0:a.burst1sDown)||0)),0),g=Object.values(C).reduce((u,a)=>Math.max(u,Number((a==null?void 0:a.burst5sDown)||0)),0),_=Object.values(C).reduce((u,a)=>Math.max(u,Number((a==null?void 0:a.burst30sDown)||0)),0);F.push({id:k.filePath||k.id||`fight-${R+1}`,shortLabel:`F${R+1}`,fullLabel:S,timestamp:ze(H,k),values:C,maxHit:n,max1s:i,max5s:r,max30s:N,maxHitDown:s,max1sDown:o,max5sDown:g,max30sDown:_})});const $=Array.from(f.values()).sort((k,R)=>R.peakHit!==k.peakHit?R.peakHit-k.peakHit:k.displayName.localeCompare(R.displayName));return{fights:F,players:$}})(),si=(()=>{const e=b=>String(b||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=b=>e(b).toLowerCase().split(/[^a-z0-9]+/i).map(S=>S.trim()).filter(Boolean).map(S=>S.length>3&&S.endsWith("s")?S.slice(0,-1):S),m=(b,S)=>{const C=e(b),I=e(S);if(!I)return C;if(!C)return I;const P=t(C),n=t(I),i=new Set(P),r=new Set(n),N=n.length>0&&n.every(o=>i.has(o)),s=P.length>0&&P.every(o=>r.has(o));return N||s?C:`${C} - ${I}`},F=[],f=new Map,j=(b,S)=>{const C=Number(b);if(!Number.isFinite(C))return{name:String(b||"Unknown Skill"),icon:void 0};const I=(S==null?void 0:S.skillMap)||{},P=(S==null?void 0:S.buffMap)||{},n=(I==null?void 0:I[`s${C}`])||(I==null?void 0:I[`${C}`]);if(n!=null&&n.name)return{name:String(n.name),icon:n==null?void 0:n.icon};const i=(P==null?void 0:P[`b${C}`])||(P==null?void 0:P[`${C}`]);return i!=null&&i.name?{name:String(i.name),icon:i==null?void 0:i.icon}:{name:`Skill ${C}`,icon:void 0}},T=(b,S)=>{let C=0,I="";const P=n=>{if(!n||typeof n!="object"||n.indirectDamage)return;const i=[Number(n.max),Number(n.maxDamage),Number(n.maxHit)].filter(N=>Number.isFinite(N)),r=i.length>0?Math.max(...i):0;r>C&&(C=r,I=j(n.id,S).name)};return Array.isArray(b==null?void 0:b.totalDamageDist)&&b.totalDamageDist.forEach(n=>{Array.isArray(n)&&n.forEach(i=>P(i))}),Array.isArray(b==null?void 0:b.targetDamageDist)&&b.targetDamageDist.forEach(n=>{Array.isArray(n)&&n.forEach(i=>{Array.isArray(i)&&i.forEach(r=>P(r))})}),{peak:C,skillName:I||"Unknown Skill"}},Z=b=>{if(!Array.isArray(b)||b.length===0)return[];const S=[];for(let C=0;C<b.length;C+=1){const I=Number(b[C]||0),P=C>0?Number(b[C-1]||0):0;S.push(Math.max(0,I-P))}return S},J=b=>{if(!Array.isArray(b)||b.length===0)return[];const S=b.reduce((I,P)=>Math.max(I,Array.isArray(P)?P.length:0),0);if(S<=0)return[];const C=new Array(S).fill(0);return b.forEach(I=>{if(Array.isArray(I))for(let P=0;P<S;P+=1)C[P]+=Number(I[P]||0)}),C},ie=b=>{if(!Array.isArray(b)||b.length===0)return[];const S=b[0];if(typeof S=="number")return b.map(C=>Number(C||0));if(Array.isArray(S)&&S.length>0){if(typeof S[0]=="number")return S.map(C=>Number(C||0));if(Array.isArray(S[0])){const C=S.map(I=>Array.isArray(I)?I.map(P=>Number(P||0)):null).filter(I=>Array.isArray(I)&&I.length>0);if(C.length>0)return J(C)}}return[]},E=b=>{const S=ie(b==null?void 0:b.powerDamage1S),C=ie(b==null?void 0:b.damage1S),I=S.length>0?S:C;return Z(I)},l=(b,S)=>{const C=b==null?void 0:b.targetPowerDamage1S;if(!Array.isArray(C)||!Array.isArray(C[S]))return[];const I=C[S];if(!Array.isArray(I)||I.length===0)return[];if(typeof I[0]=="number")return I.map(P=>Number(P||0));if(Array.isArray(I[0])&&!Array.isArray(I[0][0]))return I[0].map(P=>Number(P||0));if(Array.isArray(I[0])&&Array.isArray(I[0][0])){const n=I[0].map(i=>Array.isArray(i)?i.map(r=>Number(r||0)):null).filter(i=>Array.isArray(i)&&i.length>0);return J(n)}return[]},d=(b,S)=>{if(!Array.isArray(b)||b.length===0||S<=0)return 0;let C=0,I=0;for(let P=0;P<b.length;P+=1)C+=Number(b[P]||0),P>=S&&(C-=Number(b[P-S]||0)),P>=S-1&&C>I&&(I=C);return Math.max(0,I)},$=(b,S)=>{if(!Array.isArray(b)||b.length===0||S<=0)return[];const C=[];for(let I=0;I<b.length;I+=S){const P=Math.min(I+S,b.length),n=b.slice(I,P).reduce((i,r)=>i+Number(r||0),0);C.push(n)}return C},k=b=>Array.isArray(b)?b.map(S=>Array.isArray(S)?[Number(S[0]),Number(S[1])]:S&&typeof S=="object"?[Number(S.time),Number(S.value)]:null).filter(S=>!!S&&Number.isFinite(S[0])&&S[0]>=0):[],R=(b,S,C,I,P)=>{if(!b.length||I<=0)return[];const n=Math.max(I*5e3,P||0),i=a=>a.reduce((V,p)=>p>=0&&p<=n+2e3?V+1:V,0),r=b.map(a=>Number(a||0)).filter(a=>Number.isFinite(a)&&a>=0);if(!r.length)return[];const N=[r],s=r.reduce((a,V)=>Math.max(a,V),0),o=r.reduce((a,V)=>Math.min(a,V),Number.POSITIVE_INFINITY);s>n*20&&N.push(r.map(a=>a/1e3)),s<=n*2&&o>=0&&s>0&&s<Math.max(120,I*5+10)&&N.push(r.map(a=>a*1e3));let g=r,_=0,u=-1;return N.forEach(a=>{const V=a.reduce((D,q)=>Math.min(D,q),Number.POSITIVE_INFINITY),p=new Set([0,...S,...C]);if(Number.isFinite(V)&&n>0&&V>n){const D=Math.floor(V/n)*n;p.add(D),p.add(Math.max(0,D-n))}p.forEach(D=>{const q=a.map(O=>O-D),W=i(q);W>u&&(u=W,_=D,g=a)})}),g.map(a=>a-_).filter(a=>Number.isFinite(a)&&a>=0)},H=(b,S,C,I,P)=>{const n=R(b,S,C,I,P);return Array.from(new Set(n.map(i=>Math.floor(i/5e3)).filter(i=>Number.isFinite(i)&&i>=0&&i<I)))};se.map(b=>({log:b,ts:ze(b==null?void 0:b.details,b)})).sort((b,S)=>b.ts-S.ts).forEach(({log:b},S)=>{const C=b==null?void 0:b.details;if(!C)return;const I=e(C.fightName||b.fightName||`Fight ${S+1}`),P=bt(C,b),n=m(I,String(P||"")),i={},N=(Array.isArray(C.players)?C.players:[]).filter(w=>!(w!=null&&w.notInSquad)),s=N.flatMap(w=>{const x=w==null?void 0:w.combatReplayData;return Array.isArray(x)?x.map(K=>Number(K==null?void 0:K.start)):[Number(x==null?void 0:x.start)]}).filter(w=>Number.isFinite(w)&&w>=0),o=N.flatMap(w=>{const x=w==null?void 0:w.combatReplayData;return(Array.isArray(x)?x:x?[x]:[]).flatMap(ne=>k(ne==null?void 0:ne.down).map(([oe])=>Number(oe||0)))}),g=N.flatMap(w=>{const x=w==null?void 0:w.combatReplayData;return(Array.isArray(x)?x:x?[x]:[]).flatMap(ne=>k(ne==null?void 0:ne.dead).map(([oe])=>Number(oe||0)))}),_=new Map,u=new Map,a=new Map;(Array.isArray(C.targets)?C.targets:[]).forEach((w,x)=>{if(!w||w.isFake||!w.enemyPlayer)return;const K=rt((w==null?void 0:w.profession)||(w==null?void 0:w.name)||(w==null?void 0:w.id))||"Unknown";a.set(K,(a.get(K)||0)+1);const ne=u.get(K)||new Map;Array.isArray(w==null?void 0:w.totalDamageDist)&&w.totalDamageDist.forEach(Ce=>{Array.isArray(Ce)&&Ce.forEach(X=>{if(!X||typeof X!="object"||X.indirectDamage)return;const fe=Number(X.totalDamage||0);if(!Number.isFinite(fe)||fe<=0)return;const Le=Number(X.connectedHits||X.hits||0),Ve=j(X.id,C),Ue=Ve.name,$e=ne.get(Ue)||{skillName:Ue,damage:0,hits:0,icon:Ve.icon};$e.damage+=fe,$e.hits+=Number.isFinite(Le)?Le:0,!$e.icon&&Ve.icon&&($e.icon=Ve.icon),ne.set(Ue,$e)})}),u.set(K,ne);const oe=J(N.map(Ce=>l(Ce,x))),ue=oe.length>0?Z(oe):E(w),he=T(w,C);let Se=_.get(K);Se||(Se={perSecond:[],hit:0,skillName:""},_.set(K,Se)),ue.length>Se.perSecond.length&&(Se.perSecond.length=ue.length);for(let Ce=0;Ce<ue.length;Ce+=1)Se.perSecond[Ce]=Number(Se.perSecond[Ce]||0)+Number(ue[Ce]||0);const Ie=Number(he.peak||0);Ie>Se.hit&&(Se.hit=Ie,Se.skillName=he.skillName||"Unknown Skill")});const p=Array.from(_.values()).some(w=>Array.isArray(w.perSecond)&&w.perSecond.some(x=>Number(x||0)>0));if(_.size===0||!p){const w=J(N.map(K=>{const ne=ie(K==null?void 0:K.powerDamageTaken1S);return Z(ne)})),x=Array.from(a.values()).reduce((K,ne)=>K+Number(ne||0),0);w.length>0&&x>0&&a.forEach((K,ne)=>{const oe=Number(K||0)/x,ue=w.map(Se=>Number(Se||0)*oe),he=_.get(ne);_.set(ne,{perSecond:ue,hit:Number((he==null?void 0:he.hit)||0),skillName:String((he==null?void 0:he.skillName)||"")})})}_.forEach((w,x)=>{var Ve;const K=x,ne=Number(w.hit||0),oe=Number(d(w.perSecond,1)||0),ue=Number(d(w.perSecond,5)||0),he=Number(d(w.perSecond,30)||0),Se=Math.max(0,Math.ceil(Number((C==null?void 0:C.durationMS)||0)/5e3)),Ie=Math.max(0,Math.ceil(w.perSecond.length/5)),Ce=Math.max(Se,Ie),X=$(w.perSecond,5),fe=Array.from({length:Ce},(Ue,$e)=>Number(X[$e]||0));i[K]={hit:ne,burst1s:oe,burst5s:ue,burst30s:he,skillName:w.skillName||"Unknown Skill",buckets5s:fe,downIndices5s:H(o,[],s,Ce,Number((C==null?void 0:C.durationMS)||0)),deathIndices5s:H(g,[],s,Ce,Number((C==null?void 0:C.durationMS)||0)),skillRows:Array.from(((Ve=u.get(x))==null?void 0:Ve.values())||[]).sort((Ue,$e)=>$e.damage-Ue.damage).slice(0,50)};const Le=f.get(K)||{key:K,account:x,displayName:x,characterName:"",profession:x,professionList:[x],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};Le.logs+=1,ne>Le.peakHit&&(Le.peakHit=ne,Le.peakFightLabel=n,Le.peakSkillName=w.skillName||"Unknown Skill"),oe>Le.peak1s&&(Le.peak1s=oe),ue>Le.peak5s&&(Le.peak5s=ue),he>Le.peak30s&&(Le.peak30s=he),f.set(K,Le)});const D=Object.values(i).reduce((w,x)=>Math.max(w,Number((x==null?void 0:x.hit)||0)),0),q=Object.values(i).reduce((w,x)=>Math.max(w,Number((x==null?void 0:x.burst1s)||0)),0),W=Object.values(i).reduce((w,x)=>Math.max(w,Number((x==null?void 0:x.burst5s)||0)),0),O=Object.values(i).reduce((w,x)=>Math.max(w,Number((x==null?void 0:x.burst30s)||0)),0);F.push({id:b.filePath||b.id||`fight-${S+1}`,shortLabel:`F${S+1}`,fullLabel:n,timestamp:ze(C,b),values:i,maxHit:D,max1s:q,max5s:W,max30s:O})});const Q=Array.from(f.values()).sort((b,S)=>S.peakHit!==b.peakHit?S.peakHit-b.peakHit:b.displayName.localeCompare(S.displayName));return{fights:F,players:Q}})(),ii=Array.from(et.entries()).map(([e,t])=>{const m=Je.get(e)||{},F=Array.from(t.values()).map(f=>{var d,$;const j=Array.from(f.professions||[]).filter(k=>k&&k!=="Unknown");let T=f.profession||"Unknown";if(j.length>0){T=j[0];let k=((d=f.professionTimeMs)==null?void 0:d[T])||0;j.forEach(R=>{var Q;const H=((Q=f.professionTimeMs)==null?void 0:Q[R])||0;H>k&&(k=H,T=R)})}const Z=f.durationMs||0,J=f.totalMs/1e3,ie=Z>0?f.totalMs/Z:0,E=(($=pe.get(f.account))==null?void 0:$.supportActiveMs)||Z,l=E>0?f.uptimeMs/E:0;return{account:f.account,profession:T,professionList:j,total:J,perSecond:ie,uptimePerSecond:l,duration:Z/1e3}}).filter(f=>f.total>0||f.perSecond>0);return{id:e,name:m.name||e,icon:m.icon,rows:F}}).filter(e=>e.rows.length>0),oi=Array.from(Ye.values()).map(e=>{const t=Array.from(e.skills.values()).sort((F,f)=>f.damage-F.damage);return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:me,wins:Be,losses:_e,avgSquadSize:vs,avgEnemies:Fs,squadKDR:Bs,enemyKDR:Es,totalSquadKills:v,totalSquadDeaths:nt,totalEnemyKills:De,totalEnemyDeaths:de,leaderboards:Oe,...Us,outgoingConditionSummary:Object.values(Qe).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(tt).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(pe.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(pe.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:qs,topIncomingSkills:_s,topSkillsByDamage:On,topSkillsByDownContribution:Hn,playerSkillBreakdowns:oi,topSkillsMetric:ke,mapData:Hs,timelineData:Vs,boonTables:js,boonTimeline:zs,boonUptimeTimeline:Ks,offensePlayers:Array.from(pe.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(pe.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs,minionDamageTakenByMinion:e.defenseMinionDamageTaken})),damageMitigationPlayers:Is,damageMitigationMinions:Ps,supportPlayers:Array.from(pe.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(pe.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:nn,silver:$n,bronze:Rn,squadClassData:Gs,enemyClassData:Js,fightBreakdown:Xs,commanderStats:Qs,fightDiffMode:Zs,attendanceData:ys,squadCompByFight:ei,spikeDamage:ni,incomingStrikeDamage:si,specialTables:ii,topStatsPerSecond:ht,topStatsLeaderboardsPerSecond:gt,avgMvpScore:Wn}})(),Ke=(()=>{const ee=new Map,re=new Map,ke=[],me=new Map,Be=new Map;se.forEach(ce=>{const ve=ce.details;if(!ve)return;const nt=ve.skillMap||{},v=ve.fightName||"Log",de=ze(ve,ce)||Date.now(),De={id:ce.filePath||ce.id||v,label:v,timestamp:de,skillEntries:{},playerActiveSeconds:{},durationSeconds:ve.durationMS?ve.durationMS/1e3:0};(ve.players||[]).forEach(Te=>{if(Te.notInSquad)return;const pe=Te.account||Te.name||"Unknown",je=Te.profession||"Unknown",Ne=`${pe}|${je}`;let Fe=re.get(Ne);Fe||(Fe={key:Ne,account:pe,displayName:pe,profession:je,professionList:[je],logs:0,totalActiveSeconds:0,skillTotals:{}},re.set(Ne,Fe)),Fe.logs++;const Ye=(Array.isArray(Te.activeTimes)?Te.activeTimes[0]:0)/1e3;Fe.totalActiveSeconds=(Fe.totalActiveSeconds||0)+Ye,De.playerActiveSeconds[Ne]=Ye,(Te.rotation||[]).forEach(Qe=>{var Ot,Ht,jt;if(!(Qe!=null&&Qe.id))return;const tt=((Ot=Qe.skills)==null?void 0:Ot.length)||0;if(tt<=0)return;const We=`s${Qe.id}`,Je=((Ht=nt[We])==null?void 0:Ht.name)||`Skill ${Qe.id}`,et=(jt=nt[We])==null?void 0:jt.icon;Fe.skillTotals[We]=(Fe.skillTotals[We]||0)+tt,ee.set(We,(ee.get(We)||0)+tt),me.set(We,Je),et&&!Be.has(We)&&Be.set(We,et),De.skillEntries[We]||(De.skillEntries[We]={name:Je,icon:et,players:{}}),!De.skillEntries[We].icon&&et&&(De.skillEntries[We].icon=et),De.skillEntries[We].players[Ne]=(De.skillEntries[We].players[Ne]||0)+tt})}),ke.push(De)});const _e=Array.from(ee.entries()).map(([ce,ve])=>({id:ce,name:me.get(ce)||ce,total:ve,icon:Be.get(ce)})).sort((ce,ve)=>ve.total-ce.total);return{logRecords:ke,players:Array.from(re.values()),skillOptions:_e,resUtilitySkills:[]}})();return{validLogs:se,stats:Xe,skillUsageData:Ke}},It=(c,h)=>{const M={};return h.forEach(Y=>{c&&Object.prototype.hasOwnProperty.call(c,Y)&&(M[Y]=c[Y])}),M},An=c=>!!(c&&c.__statsPruned===!0),Mn=(c,h)=>{if(!c||typeof c!="object")return c;const M={};return Object.entries(c).forEach(([Y,y])=>{if(!y||typeof y!="object")return;const z={};typeof y.name=="string"&&(z.name=y.name),typeof y.icon=="string"&&(z.icon=y.icon),h!=null&&h.includeClassification&&typeof y.classification=="string"&&(z.classification=y.classification),h!=null&&h.includeStacking&&(typeof y.stacking=="boolean"?z.stacking=y.stacking:typeof y.stacking=="number"&&(z.stacking=!!y.stacking)),Object.keys(z).length>0&&(M[Y]=z)}),M},Cn=c=>{var M;const h=(M=c==null?void 0:c.statsAll)==null?void 0:M[0];return!h||typeof h!="object"?!1:h.distToCom!==void 0&&h.distToCom!=="Infinity"||h.stackDist!==void 0},wn=(c,h)=>{const M=Y=>{if(!Y||typeof Y!="object")return null;const y=It(Y,["start","down","dead"]);return h&&Array.isArray(Y.positions)&&(y.positions=Y.positions),y};return Array.isArray(c)?c.map(Y=>M(Y)).filter(Y=>!!Y):c&&typeof c=="object"?M(c):c},Tn=c=>{if(!c||typeof c!="object")return c;const h=It(c,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","zone","mapName","map","location","permalink","uploadLinks","success","teamBreakdown","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);if(h.skillMap=Mn(h.skillMap,{includeClassification:!1,includeStacking:!1}),h.buffMap=Mn(h.buffMap,{includeClassification:!0,includeStacking:!0}),Array.isArray(h.players)){const M=c.players,y=M.filter(z=>!(z!=null&&z.notInSquad)).some(z=>!(z!=null&&z.hasCommanderTag)&&!Cn(z));h.players=M.map(z=>{const Ae=It(z,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","hasCommanderTag","notInSquad","account","activeTimes","teamID","teamId","team","teamColor","team_color"]),se=Array.isArray(z==null?void 0:z.minions)?z.minions:[];Ae.minions=se.map(Me=>It(Me,["name","totalDamageTakenDist"]));const ge=(z==null?void 0:z.hasCommanderTag)&&!(z!=null&&z.notInSquad)||y&&!(z!=null&&z.notInSquad)&&!Cn(z);return Ae.combatReplayData=wn(z==null?void 0:z.combatReplayData,ge),Ae})}return Array.isArray(h.targets)&&(h.targets=h.targets.map(M=>{const Y=It(M,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","totalDamageTaken","totalDamageTakenDist","damageTaken","powerDamage1S","damage1S","profession","teamID","teamId","team","teamColor","team_color"]);return Y.combatReplayData=wn(M==null?void 0:M.combatReplayData,!1),Y})),h},Ss=c=>{if(!c||typeof c!="object"||An(c))return c;const h={...c};return c.details?h.details=Tn(c.details):h.details=Tn(c),h.__statsPruned=!0,h};let at=null,vn=0,Qt=0,Rt=null,Wt=0,Zt=0;const As=c=>typeof(c==null?void 0:c.token)=="number"&&c.token!==Qt,Ms=c=>{const h=c==null?void 0:c.stats;if(!h||typeof h!="object")return{spikeSkillRowsRemoved:0,incomingSkillRowsRemoved:0,playerSkillMapsRemoved:0};const M=se=>{let ge=0;return(Array.isArray(se==null?void 0:se.fights)?se.fights:[]).forEach(ye=>{if(!ye||typeof ye!="object")return;const Xe=ye.values;!Xe||typeof Xe!="object"||Object.values(Xe).forEach(Ke=>{!Ke||typeof Ke!="object"||Array.isArray(Ke.skillRows)&&(delete Ke.skillRows,ge+=1)})}),ge},Y=M(h.spikeDamage),y=M(h.incomingStrikeDamage);let z=0;return(Array.isArray(h.playerSkillBreakdowns)?h.playerSkillBreakdowns:[]).forEach(se=>{!se||typeof se!="object"||se.skillMap&&typeof se.skillMap=="object"&&(delete se.skillMap,z+=1)}),{spikeSkillRowsRemoved:Y,incomingSkillRowsRemoved:y,playerSkillMapsRemoved:z}},Cs=()=>{var Ae,se;if(!at)return;vn+=1;const c=Rt;Rt=null;const h=performance.now(),M=Ns({...at,includePlayerSkillMap:!1}),Y=Ms(M),y=Math.max(0,performance.now()-h),z=M==null?void 0:M.stats;self.postMessage({type:"result",result:M,computeId:vn,logCount:at.logs.length,token:Qt,completedAt:Date.now(),flushId:c,diagnostics:{computeMs:y,logsInPayload:at.logs.length,expectedLogCount:Wt,droppedLogMessages:Zt,transferStripStats:Y,counts:{playerSkillBreakdowns:Array.isArray(z==null?void 0:z.playerSkillBreakdowns)?z.playerSkillBreakdowns.length:0,spikeFights:Array.isArray((Ae=z==null?void 0:z.spikeDamage)==null?void 0:Ae.fights)?z.spikeDamage.fights.length:0,incomingStrikeFights:Array.isArray((se=z==null?void 0:z.incomingStrikeDamage)==null?void 0:se.fights)?z.incomingStrikeDamage.fights.length:0}}})};self.onmessage=c=>{var M,Y,y,z;const h=c.data;if((h==null?void 0:h.type)==="reset"){at={logs:[]},typeof h.token=="number"&&(Qt=h.token),Wt=Math.max(0,Number(h.totalLogs||0)),Zt=0,Rt=null;return}if(!As(h)){if((h==null?void 0:h.type)==="settings"){at={logs:(at==null?void 0:at.logs)||[],precomputedStats:(M=h.payload)==null?void 0:M.precomputedStats,mvpWeights:(Y=h.payload)==null?void 0:Y.mvpWeights,statsViewSettings:(y=h.payload)==null?void 0:y.statsViewSettings,disruptionMethod:(z=h.payload)==null?void 0:z.disruptionMethod};return}if((h==null?void 0:h.type)==="log"){if(at||(at={logs:[]}),Wt>0&&at.logs.length>=Wt){Zt+=1;return}at.logs.push(An(h.payload)?h.payload:Ss(h.payload));return}(h==null?void 0:h.type)==="flush"&&(typeof h.flushId=="number"&&(Rt=h.flushId),Cs())}}})();
